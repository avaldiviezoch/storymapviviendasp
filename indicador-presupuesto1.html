<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Presupuesto Institucional Modificado 2025</title>
  <style>
    :root{
      --ink:#083b37;
      --muted:#5b6b80;
      --ring:#e8edf3;
      --shadow:0 6px 18px rgba(2, 6, 23, .06);
      --brand:#0e766e;
    }
    html,body{margin:0;background:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
    .wrap{display:flex;justify-content:center;padding:18px}
    .card{
      width:100%; max-width:820px;
      background:#fff; border:1px solid var(--ring); border-radius:16px;
      box-shadow:var(--shadow);
      padding:22px 20px 18px;
    }
    .title{
      text-align:center; font-size:26px; font-weight:800; margin:0 0 16px;
      color:#0f172a; letter-spacing:.2px;
    }

    /* KPI */
    .kpi{ display:flex; flex-direction:column; align-items:center; }
    .valueRow{
      display:inline-flex; align-items:baseline; gap:10px;
      flex-wrap:wrap; justify-content:center;
      padding:8px 0 6px;
    }
    .currency{
      font-size:26px; font-weight:800; color:var(--ink); opacity:.9;
      line-height:1;
    }
    .value{
      font-size:56px; line-height:1.02; font-weight:900; color:var(--ink);
      letter-spacing:.02em; text-align:center; word-break:break-word;
    }
    .unit{
      margin-top:6px; font-weight:800; letter-spacing:.22em;
      color:#0f172a; font-size:12px;
    }

    .loading,.error{ text-align:center; color:var(--muted); font-size:13px; margin-top:8px }
    .error{ color:#b91c1c }

    .meta{
      margin-top:14px; display:flex; align-items:center; justify-content:center;
      gap:8px; color:var(--muted); font-size:13px;
    }
    .dot{ width:7px; height:7px; border-radius:999px; background:var(--brand) }

    /* Responsive */
    @media (max-width:720px){
      .title{font-size:20px}
      .currency{font-size:20px}
      .value{font-size:40px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 class="title">Presupuesto Institucional Modificado 2025</h1>

      <div class="kpi">
        <div class="valueRow">
          <span class="currency">S/.</span>
          <span class="value" id="value">—</span>
        </div>
        <div class="unit">PIM</div>
        <div class="loading" id="loading">Consultando servicio…</div>
        <div class="error" id="error" style="display:none"></div>
      </div>

      <div class="meta">
        <span class="dot" aria-hidden="true"></span>
        <span><strong>Fuente:</strong> Ministerio de Economía y Finanzas — MEF · Portal de Datos Abiertos</span>
      </div>
    </div>
  </div>

<script>
  /* ===== Config ===== */
  const ENDPOINT = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
  const SECTOR   = "VIVIENDA CONSTRUCCION Y SANEAMIENTO";
  const ANIO     = 2025; // cambia aquí si necesitas otro año

  const nf = new Intl.NumberFormat("es-PE");
  const $val = document.getElementById("value");
  const $load = document.getElementById("loading");
  const $err = document.getElementById("error");

  function postForm(url, params){
    return fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
      body: new URLSearchParams(params).toString(),
      cache: "no-store",
      credentials: "omit"
    });
  }

  async function sumByStatistics(where){
    const res = await postForm(ENDPOINT, {
      where,
      outStatistics: JSON.stringify([{
        statisticType: "sum",
        onStatisticField: "monto_pim",
        outStatisticFieldName: "sum_pim"
      }]),
      sqlFormat: "standard",
      returnGeometry: "false",
      f: "json"
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const json = await res.json();
    if(json.error) throw new Error(json.error.message || "Error del servicio");
    const sum = json.features?.[0]?.attributes?.sum_pim;
    return Number(sum) || 0;
  }

  async function countRows(where){
    const res = await postForm(ENDPOINT, { where, returnCountOnly:"true", f:"json" });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const j = await res.json();
    return Number(j.count) || 0;
  }

  async function clientSideSum(){
    const res = await postForm(ENDPOINT, {
      where: `ano_eje=${ANIO} AND sector_nombre IS NOT NULL`,
      outFields: "sector_nombre,monto_pim",
      resultRecordCount: 32000,
      returnGeometry: "false",
      f:"json"
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const j = await res.json();
    const rows = (j.features||[]).map(f => f.attributes||{});
    const norm = s => String(s||"").trim().replace(/\s+/g," ").toUpperCase();
    let acc = 0;
    for(const r of rows){
      if(norm(r.sector_nombre) === norm(SECTOR)){
        const v = Number(r.monto_pim);
        if(Number.isFinite(v)) acc += v;
      }
    }
    return acc;
  }

  function countUp(to, ms=1500){
    const start = performance.now();
    function tick(t){
      const k = Math.min(1, (t - start)/ms);
      const eased = 1 - Math.pow(1-k, 3);
      const val = Math.round(to*eased);
      $val.textContent = nf.format(val);
      if(k < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  (async function run(){
    try{
      let where = `sector_nombre='${SECTOR.replace(/'/g,"''")}' AND ano_eje=${ANIO}`;
      let total = await sumByStatistics(where);

      if(total === 0){
        const c = await countRows(where);
        if(c === 0){
          where = `sector_nombre LIKE '${SECTOR.replace(/'/g,"''")}%' AND ano_eje=${ANIO}`;
          total = await sumByStatistics(where);
        }
      }
      if(total === 0){
        total = await clientSideSum();
      }

      $load.style.display = "none";
      countUp(Math.round(total));
    }catch(e){
      console.error(e);
      $load.style.display = "none";
      $err.style.display = "block";
      $err.textContent = "No fue posible obtener el PIM. Revisa el acceso público o los filtros.";
      $val.textContent = "—";
    }
  })();
</script>
</body>
</html>
