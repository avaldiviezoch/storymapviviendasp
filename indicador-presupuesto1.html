<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Presupuesto Institucional Modificado 2025</title>
  <style>
    :root{
      --ink:#0b3b37;
      --muted:#64748b;
      --ring:#e2e8f0;
      --brand:#0f766e;
    }
    html,body{height:100%;margin:0;background:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
    .card{
      max-width:980px; margin:48px auto; padding:28px 24px; background:#fff;
      border:1px solid var(--ring); border-radius:18px;
      box-shadow:0 6px 24px rgba(2,6,23,.06);
    }
    .title{ text-align:center; font-size:32px; font-weight:800; margin:0 0 28px; color:#0f172a; }
    .kpi{ display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px 16px 28px; }
    .currency{ font-size:28px; color:var(--ink); opacity:.9; margin-bottom:6px }
    .value{ font-size:64px; line-height:1.05; font-weight:900; color:var(--ink); text-align:center; letter-spacing:.02em; word-break:break-word; }
    .unit{ margin-top:14px; font-weight:700; letter-spacing:.15em; color:#0f172a; }
    .meta{ margin-top:28px; display:flex; align-items:center; justify-content:center; gap:10px; color:var(--muted); font-size:13px; }
    .dot{ width:8px; height:8px; border-radius:999px; background:var(--brand); }
    .loading,.error{ text-align:center; color:var(--muted); font-size:14px; margin-top:12px; }
    .error{ color:#b91c1c }
    @media (max-width:720px){ .title{font-size:22px} .value{font-size:44px} }
  </style>
</head>
<body>
  <div class="card">
    <!-- Cambia aquí el título si lo deseas -->
    <h1 class="title">Presupuesto Institucional Modificado 2025</h1>

    <div class="kpi">
      <div class="currency">S/.</div>
      <div class="value" id="value">—</div>
      <div class="unit">PIM</div>
      <div class="loading" id="loading">Consultando servicio…</div>
      <div class="error" id="error" style="display:none"></div>
    </div>

    <div class="meta">
      <span class="dot" aria-hidden="true"></span>
      <span><strong>Fuente:</strong> Ministerio de Economía y Finanzas — MEF · Portal de Datos Abiertos</span>
    </div>
  </div>

<script>
  /* ===== Config ===== */
  const ENDPOINT = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
  const SECTOR   = "VIVIENDA CONSTRUCCION Y SANEAMIENTO";
  const ANIO     = 2025; // <-- cámbialo cuando necesites

  const nf = new Intl.NumberFormat("es-PE");
  const $val = document.getElementById("value");
  const $load = document.getElementById("loading");
  const $err = document.getElementById("error");

  function postForm(url, params){
    return fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
      body: new URLSearchParams(params).toString(),
      cache: "no-store",
      credentials: "omit"
    });
  }

  async function sumByStatistics(where){
    const res = await postForm(ENDPOINT, {
      where,
      outStatistics: JSON.stringify([{
        statisticType: "sum",
        onStatisticField: "monto_pim",
        outStatisticFieldName: "sum_pim"
      }]),
      sqlFormat: "standard",
      returnGeometry: "false",
      f: "json"
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const json = await res.json();
    if(json.error) throw new Error(json.error.message || "Error del servicio");
    const sum = json.features?.[0]?.attributes?.sum_pim;
    return Number(sum) || 0;
  }

  async function countRows(where){
    const res = await postForm(ENDPOINT, {
      where, returnCountOnly: "true", f:"json"
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const j = await res.json();
    return Number(j.count) || 0;
  }

  // Último recurso: traer valores y sumar localmente (normalizando el texto)
  async function clientSideSum(){
    const res = await postForm(ENDPOINT, {
      where: `ano_eje=${ANIO} AND sector_nombre IS NOT NULL`,
      outFields: "sector_nombre,monto_pim",
      resultRecordCount: 32000, // tope amplio
      returnGeometry: "false",
      f:"json"
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const j = await res.json();
    const rows = (j.features||[]).map(f => f.attributes||{});
    const norm = s => String(s||"").trim().replace(/\s+/g," ").toUpperCase();
    let acc = 0;
    for(const r of rows){
      if(norm(r.sector_nombre) === norm(SECTOR)){
        const v = Number(r.monto_pim);
        if(Number.isFinite(v)) acc += v;
      }
    }
    return acc;
  }

  function countUp(to, ms=1600){
    const start = performance.now();
    function tick(t){
      const k = Math.min(1, (t - start)/ms);
      const eased = 1 - Math.pow(1-k, 3);
      const val = Math.round(to*eased);
      $val.textContent = nf.format(val);
      if(k < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  (async function run(){
    try{
      // 1) where exacto (igual que en Portal)
      let where = `sector_nombre='${SECTOR.replace(/'/g,"''")}' AND ano_eje=${ANIO}`;
      let total = await sumByStatistics(where);

      if(total === 0){
        // 2) ¿Hay filas? si no, reintento con LIKE (por si hay espacios adicionales)
        const c = await countRows(where);
        if(c === 0){
          where = `sector_nombre LIKE '${SECTOR.replace(/'/g,"''")}%' AND ano_eje=${ANIO}`;
          total = await sumByStatistics(where);
        }
      }

      if(total === 0){
        // 3) Último recurso: sumar en cliente normalizando texto
        total = await clientSideSum();
      }

      $load.style.display = "none";
      countUp(Math.round(total));
    }catch(e){
      console.error(e);
      $load.style.display = "none";
      $err.style.display = "block";
      $err.textContent = "No fue posible obtener el PIM. Revisa el acceso público o los filtros.";
      $val.textContent = "—";
    }
  })();
</script>
</body>
</html>
