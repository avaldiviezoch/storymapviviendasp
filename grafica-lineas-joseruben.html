<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Evolución (PORCENTAJE) por ámbito — NACIONAL</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    :root { --bg:#0f172a; --fg:#e5e7eb; --chip:#111827; --chip-on:#1f2937; }
    html,body{height:100%;margin:0;background:#fff;font-family:system-ui,Arial}
    #topbar{
      position:fixed; inset:0 0 auto 0; height:56px; display:flex; align-items:center; gap:12px;
      padding:0 16px; background:var(--bg); color:var(--fg); z-index:9;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
    }
    #chart{ position:absolute; top:56px; bottom:0; left:0; right:0; }
    .seg { display:inline-flex; border:1px solid #334155; border-radius:12px; overflow:hidden }
    .chip{
      display:flex; align-items:center; gap:8px; padding:6px 12px; cursor:pointer;
      background:var(--chip); color:#cbd5e1; user-select:none;
    }
    .chip input{ appearance:none; width:18px; height:18px; border:2px solid #64748b; border-radius:4px; display:inline-block; }
    .chip input:checked{ background:#22c55e; border-color:#22c55e; }
    .chip.on{ background:var(--chip-on); color:#fff; }
    .spacer{ flex:1; }
    .hint{ font-size:13px; opacity:.85 }
  </style>
</head>
<body>
  <div id="topbar">
    <div class="hint">Mostrar series:</div>
    <div id="seriesToggles" class="seg">
      <label class="chip on"><input type="checkbox" data-ser="RURAL" checked> RURAL</label>
      <label class="chip on"><input type="checkbox" data-ser="URBANO" checked> URBANO</label>
      <label class="chip on"><input type="checkbox" data-ser="TOTAL" checked> TOTAL</label>
    </div>
    <div class="spacer"></div>
    <div class="hint">Fuente: FS/4 • Filtros: cod_var=1, unidad='PORCENTAJE', región='NACIONAL'</div>
  </div>

  <div id="chart"></div>

<script>
const SERVICE_URL = "https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/mapa_swipe_viviendas_promovidas_storymap/FeatureServer/4/query";

function qs(url, params){
  return url + "?" + new URLSearchParams(params).toString();
}

async function fetchRows(){
  const url = qs(SERVICE_URL, {
    where: "cod_var=1 AND unidad='PORCENTAJE' AND region_nombre='NACIONAL'",
    outFields: "*",
    returnGeometry: "false",
    orderByFields: "anio ASC, ambito ASC",
    f: "json"
  });
  const res = await fetch(url, { cache: 'no-store' });
  if(!res.ok) throw new Error("HTTP "+res.status);
  const json = await res.json();
  if(json.error) throw new Error(json.error.message || "Error del servicio");
  return (json.features || []).map(f => f.attributes);
}

(function main(){
  const chart = echarts.init(document.getElementById('chart'));
  const colorMap = { RURAL: '#ef4444', URBANO: '#3b82f6', TOTAL: '#10b981' };
  const legendSelected = { RURAL: true, URBANO: true, TOTAL: true };

  (async()=>{
    try{
      chart.showLoading({ text: "Cargando datos…" });
      const rows = await fetchRows();

      // Años disponibles (orden ascendente y únicos)
      const years = Array.from(
        new Set(rows.map(r => Number(r.anio)).filter(v => Number.isFinite(v)))
      ).sort((a,b)=>a-b);

      // Índice rápido de año -> posición en eje
      const yearIdx = new Map(years.map((y,i)=>[y,i]));

      // Estructuras de datos alineadas por año
      const seriesVals = {
        RURAL:  new Array(years.length).fill(null),
        URBANO: new Array(years.length).fill(null),
        TOTAL:  new Array(years.length).fill(null)
      };

      // Poblar valores
      for(const r of rows){
        const a = Number(r.anio);
        const amb = String(r.ambito || '').toUpperCase().trim(); // RURAL/URBANO/TOTAL
        const val = Number(r.valor);
        if(yearIdx.has(a) && amb in seriesVals && Number.isFinite(val)){
          seriesVals[amb][yearIdx.get(a)] = val;
        }
      }

      const option = {
        title: {
          text: "Evolución (PORCENTAJE) por ámbito — NACIONAL",
          left: "center",
          top: 10
        },
        color: [colorMap.RURAL, colorMap.URBANO, colorMap.TOTAL],
        legend: {
          top: 42,
          selected: legendSelected,
          data: ["RURAL","URBANO","TOTAL"]
        },
        grid: { top: 80, left: 60, right: 24, bottom: 48 },
        tooltip: {
          trigger: "axis",
          valueFormatter: v => (v == null ? "—" : v.toFixed(2) + " %")
        },
        xAxis: {
          type: "category",
          name: "Año",
          nameGap: 20,
          nameLocation: "middle",
          data: years.map(String)
        },
        yAxis: {
          type: "value",
          name: "Valor (PORCENTAJE)",
          min: 60, max: 100,
          axisLabel: { formatter: v => v + " %" }
        },
        series: [
          {
            name: "RURAL",
            type: "line",
            connectNulls: false,
            showSymbol: true,
            symbolSize: 6,
            smooth: true,
            data: seriesVals.RURAL
          },
          {
            name: "URBANO",
            type: "line",
            connectNulls: false,
            showSymbol: true,
            symbolSize: 6,
            smooth: true,
            data: seriesVals.URBANO
          },
          {
            name: "TOTAL",
            type: "line",
            connectNulls: false,
            showSymbol: true,
            symbolSize: 6,
            smooth: true,
            data: seriesVals.TOTAL
          }
        ]
      };

      chart.hideLoading();
      chart.setOption(option);

      // Switch UI: mostrar/ocultar series
      const toggles = document.getElementById('seriesToggles');
      toggles.addEventListener('change', (e)=>{
        const inp = e.target.closest('input[data-ser]');
        if(!inp) return;
        const key = inp.dataset.ser;
        legendSelected[key] = inp.checked;
        // efecto visual del chip
        const chip = inp.parentElement;
        chip.classList.toggle('on', inp.checked);
        // actualizar leyenda seleccionada (es la forma más limpia de ocultar series)
        chart.setOption({ legend: { selected: legendSelected } });
      });

      window.addEventListener('resize', ()=> chart.resize());
    }catch(err){
      console.error(err);
      chart.hideLoading();
      chart.setOption({
        title:{ text: 'Error al cargar/graficar', left:'center' },
        graphic:{
          type:'text', left:'center', top:'middle',
          style:{ text: err?.message || 'Fallo de carga.\nRevisa acceso público del servicio o los campos.', fontSize: 14 }
        }
      });
    }
  })();
})();
</script>
</body>
</html>
