<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Evolución (PORCENTAJE) por ámbito — NACIONAL</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    /* Todo blanco para que flote bien en StoryMap */
    html,body{height:100%;margin:0;background:#fff;font-family:system-ui,Arial}
    #chart{position:fixed; inset:0; } /* ocupa todo el contenedor */
  </style>
</head>
<body>
  <div id="chart"></div>

<script>
const SERVICE_URL = "https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/mapa_swipe_viviendas_promovidas_storymap/FeatureServer/4/query";

function qs(url, params){
  return url + "?" + new URLSearchParams(params).toString();
}

async function fetchRows(){
  const url = qs(SERVICE_URL, {
    where: "cod_var=1 AND unidad='PORCENTAJE' AND region_nombre='NACIONAL'",
    outFields: "*",
    returnGeometry: "false",
    orderByFields: "anio ASC, ambito ASC",
    f: "json"
  });
  const res = await fetch(url, { cache: 'no-store' });
  if(!res.ok) throw new Error("HTTP "+res.status);
  const json = await res.json();
  if(json.error) throw new Error(json.error.message || "Error del servicio");
  return (json.features || []).map(f => f.attributes);
}

(function main(){
  const chart = echarts.init(document.getElementById('chart'));
  const colorMap = { RURAL: '#ef4444', URBANO: '#3b82f6', TOTAL: '#10b981' };

  (async()=>{
    try{
      chart.showLoading({ text: "Cargando datos…" });
      const rows = await fetchRows();

      // Años disponibles (únicos y ordenados)
      const years = Array.from(
        new Set(rows.map(r => Number(r.anio)).filter(v => Number.isFinite(v)))
      ).sort((a,b)=>a-b);

      const yearIdx = new Map(years.map((y,i)=>[y,i]));

      // Series alineadas por año
      const seriesVals = {
        RURAL:  new Array(years.length).fill(null),
        URBANO: new Array(years.length).fill(null),
        TOTAL:  new Array(years.length).fill(null)
      };

      // Poblar
      for(const r of rows){
        const a = Number(r.anio);
        const amb = String(r.ambito || '').toUpperCase().trim(); // RURAL/URBANO/TOTAL
        const val = Number(r.valor);
        if(yearIdx.has(a) && amb in seriesVals && Number.isFinite(val)){
          seriesVals[amb][yearIdx.get(a)] = val;
        }
      }

      const option = {
        backgroundColor: '#ffffff',
        title: {
          text: "Evolución (PORCENTAJE) por ámbito — NACIONAL",
          left: "center",
          top: 6,
          textStyle: { fontSize: 16, fontWeight: 600 }
        },
        color: [colorMap.RURAL, colorMap.URBANO, colorMap.TOTAL],
        legend: {
          top: 36,
          data: ["RURAL","URBANO","TOTAL"]
        },
        grid: { top: 72, left: 56, right: 24, bottom: 44 },
        tooltip: {
          trigger: "axis",
          valueFormatter: v => (v == null ? "—" : v.toFixed(2) + " %")
        },
        xAxis: {
          type: "category",
          name: "Año",
          nameGap: 20,
          nameLocation: "middle",
          axisTick: { alignWithLabel: true },
          data: years.map(String)
        },
        yAxis: {
          type: "value",
          name: "Valor (PORCENTAJE)",
          min: 60, max: 100,    /* ajusta si deseas */
          axisLabel: { formatter: v => v + " %" },
          splitLine: { show: true }
        },
        series: [
          {
            name: "RURAL",
            type: "line",
            connectNulls: false,
            showSymbol: true,
            symbolSize: 6,
            smooth: true,
            data: seriesVals.RURAL
          },
          {
            name: "URBANO",
            type: "line",
            connectNulls: false,
            showSymbol: true,
            symbolSize: 6,
            smooth: true,
            data: seriesVals.URBANO
          },
          {
            name: "TOTAL",
            type: "line",
            connectNulls: false,
            showSymbol: true,
            symbolSize: 6,
            smooth: true,
            data: seriesVals.TOTAL
          }
        ]
      };

      chart.hideLoading();
      chart.setOption(option);
      window.addEventListener('resize', ()=> chart.resize());
    }catch(err){
      console.error(err);
      chart.hideLoading();
      chart.setOption({
        title:{ text: 'Error al cargar/graficar', left:'center' },
        graphic:{
          type:'text', left:'center', top:'middle',
          style:{ text: err?.message || 'Fallo de carga.\nRevisa acceso público del servicio o los campos.', fontSize: 14 }
        }
      });
    }
  })();
})();
</script>
</body>
</html>

</body>
</html>
