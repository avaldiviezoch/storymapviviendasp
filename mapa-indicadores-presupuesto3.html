<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mapa ¬∑ Inversiones MEF (puntos) + Indicadores</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.29/"></script>

<style>
  :root{
    --ink:#0b2532; --muted:#64748b; --card:#fff;
    --g-dark:#0f3f3a; --g-2:#7da39e; --line:#e6ecea; --panel:#f7fbfa;
    --bar:#0b3b38;
  }
  html,body{margin:0; height:100%; overflow:hidden; background:#eef5f3; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .shell{display:grid; grid-template-columns: 1fr min(44vw, 720px); height:100vh; width:100vw;}
  #viewWrap{ position:sticky; top:0; height:100vh; overflow:hidden; }
  #viewDiv{position:relative; width:100%; height:100%}

  .filters{position:absolute; left:14px; top:14px; z-index:6; width:min(360px, 92vw)}
  .acc{background:#0b3b38;color:#e6fffb;border-radius:14px;box-shadow:0 12px 28px rgba(0,0,0,.18);overflow:hidden}
  .acc summary{list-style:none;cursor:pointer;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;font-weight:800}
  .acc summary::-webkit-details-marker{display:none}
  .acc .content{padding:12px 14px;display:grid;gap:10px}
  .acc label{font-size:12px;color:#cbe8e5;font-weight:700}
  .acc select{width:100%;border-radius:10px;padding:10px 12px;border:1px solid #155149;background:#0f2e29;color:#e6fffb}
  .hint{font-size:12px;color:#b9d5d1}
  .rowBtns{display:flex;gap:10px;justify-content:flex-end}
  .btn{background:#0b3b38;color:#ecfffb;border:1px solid #0e4a43;padding:8px 12px;border-radius:10px;font-weight:800;cursor:pointer; box-shadow:0 6px 16px rgba(2,6,23,.18)}
  .btn.secondary{background:#114d46;border-color:#0d3a35}

  .sidebar{background:var(--panel); border-left:1px solid var(--line); box-shadow:-6px 0 24px rgba(2,6,23,.06); padding:16px 16px 18px; box-sizing:border-box;}
  .topTitle{text-align:center; font-weight:900; letter-spacing:.2px; font-size:clamp(18px, 2.2vh, 22px); margin:2px 0 6px;}
  .bigCount{text-align:center; font-weight:900; color:#0b3b38; font-size:clamp(42px, 8vh, 64px); line-height:1; margin:4px 0 10px;}
  .bar{background:var(--bar); color:#e7fff9; font-weight:800; text-align:center; padding:10px 12px; border-radius:10px; margin:6px 0 12px; font-size:clamp(12px, 1.6vh, 14px);}

  .kpiGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
  .kpiCard{display:flex; align-items:center; gap:12px; background:#fff; border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow:0 10px 24px rgba(2,6,23,.06);}
  .badge{flex:0 0 clamp(36px, 5vh, 46px); width:clamp(36px, 5vh, 46px); height:clamp(36px, 5vh, 46px); border-radius:50%; display:grid; place-items:center; background:var(--g-2); color:#fff; font-size:clamp(18px, 2.4vh, 22px); font-weight:900}
  .metric{display:flex; flex-direction:column; align-items:flex-start}
  .metric .val{font-size:clamp(28px, 4.6vh, 44px); font-weight:900; color:var(--g-dark); line-height:1}
  .metric .lbl{font-size:clamp(12px, 1.8vh, 14px); font-weight:700; color:var(--muted); margin-top:6px}
  .sep{height:1px;background:var(--line); margin:12px 0}

  .grid8{display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; margin-top:6px;}
  .tile{background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:0 10px 24px rgba(2,6,23,.06); padding:12px; display:grid; justify-items:center; align-content:center; gap:6px; min-height:clamp(92px, 13vh, 120px);}
  .tile .v{font-size:clamp(26px, 4.3vh, 40px); font-weight:900; color:var(--g-dark); line-height:1}
  .tile .t{font-size:clamp(11px, 1.8vh, 13px); color:var(--muted); font-weight:800; text-align:center}

  @media (max-width: 1100px){ .shell{grid-template-columns: 1fr min(50vw, 720px);} }
  @media (max-width: 900px){
    .shell{grid-template-columns:1fr;}
    #viewWrap{position:relative; height:50vh;}
    .kpiGrid{grid-template-columns:1fr}
    .grid8{grid-template-columns: repeat(2, 1fr);}
  }
  @media (max-height: 760px){ .sep{margin:8px 0} .grid8{gap:10px} .kpiGrid{gap:10px} }

  /* ====== POPUP CUSTOM ====== */
  .pop-card{background:#ffffff; border:1px solid var(--line); border-radius:14px; box-shadow:0 12px 30px rgba(2,6,23,.12); overflow:hidden; min-width:min(360px, 78vw); max-width:min(520px, 86vw); color:#0b2532; font:12.5px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
  .pop-hdr{background:#0b3b38; color:#e6fffb; padding:10px 12px; font-weight:900; letter-spacing:.2px;}
  .pop-grid{display:grid; grid-template-columns:1fr 1fr; gap:8px 12px; padding:12px;}
  .pop-grid .lbl{font-weight:800; color:#47606b; font-size:11.5px}
  .pop-grid .val{font-weight:800; color:#0b2532}
  .pop-chipwrap{display:flex; gap:8px; padding:0 12px 10px}
  .chip{background:#e8f5f3; color:#0b3b38; border:1px solid #cfe7e3; padding:5px 8px; border-radius:999px; font-weight:900; font-size:11px;}
  .pop-actions{display:flex; gap:8px; justify-content:flex-end; padding:10px 12px 12px; border-top:1px solid var(--line);}
  .pop-btn{appearance:none; border:1px solid #0e4a43; background:#0b3b38; color:#e6fffb; padding:8px 10px; border-radius:10px; font-weight:800; text-decoration:none; display:inline-flex; align-items:center; gap:8px;}
  .pop-btn:hover{filter:brightness(1.05)}
  .link-ic{font-size:14px}

  /* Ocultar cabecera nativa del popup de ArcGIS */
  .esri-popup__header{display:none !important;}
  .esri-popup__main-container{padding-top:0 !important;}
</style>
</head>
<body>
<div class="shell">

  <!-- Mapa (izquierda) -->
  <div id="viewWrap">
    <div id="viewDiv" aria-label="Mapa de proyectos MEF"></div>

    <!-- Filtro retr√°ctil -->
    <div class="filters">
      <details id="acc" class="acc" open>
        <summary>Filtrar por ubicaci√≥n <span style="font-weight:900">‚ñæ</span></summary>
        <div class="content">
          <div>
            <label for="selDep">Departamento</label>
            <select id="selDep"><option value="">(Todos)</option></select>
          </div>
          <div>
            <label for="selProv">Provincia</label>
            <select id="selProv" disabled><option value="">(Todos)</option></select>
          </div>
          <div>
            <label for="selDist">Distrito</label>
            <select id="selDist" disabled><option value="">(Todos)</option></select>
          </div>
          <div class="rowBtns">
            <button id="btnClear" class="btn secondary" type="button">Limpiar filtros</button>
          </div>
          <div class="hint">Los filtros se aplican a los puntos y a los indicadores.</div>
        </div>
      </details>
    </div>
  </div>

  <!-- Panel derecho -->
  <aside class="sidebar">
    <div class="topTitle">A trav√©s de Inversiones</div>
    <div class="bigCount" id="kpiCount">‚Äî</div>

    <div class="bar">Se espera generar</div>

    <!-- 4 KPIs superiores -->
    <div class="kpiGrid">
      <div class="kpiCard" aria-live="polite">
        <div class="badge">üíß</div>
        <div class="metric"><div class="val" id="kpiAgua">‚Äî</div><div class="lbl">Conexiones Nuevas de Agua</div></div>
      </div>
      <div class="kpiCard" aria-live="polite">
        <div class="badge">üö∞</div>
        <div class="metric"><div class="val" id="kpiAlc">‚Äî</div><div class="lbl">Conexiones Nuevas de Alcantarillado</div></div>
      </div>
      <div class="kpiCard" aria-live="polite">
        <div class="badge">üõ£Ô∏è</div>
        <div class="metric"><div class="val" id="kpiPav">‚Äî</div><div class="lbl">M2 de Pavimento</div></div>
      </div>
      <div class="kpiCard" aria-live="polite">
        <div class="badge">üë∑</div>
        <div class="metric"><div class="val" id="kpiVer">‚Äî</div><div class="lbl">M2 de Vereda</div></div>
      </div>
    </div>

    <div class="sep"></div>

    <!-- 8 indicadores (reordenados) -->
    <section class="grid8">
      <!-- 1) Obras Concluidas -->
      <div class="tile"><div class="v" id="kObrasConcluidas">‚Äî</div><div class="t">Obras Concluidas</div></div>

      <!-- 2) Obras en Ejecuci√≥n -->
      <div class="tile"><div class="v" id="kObrasEjec">‚Äî</div><div class="t">Obras en Ejecuci√≥n</div></div>

      <!-- 3) Obras por Iniciar -->
      <div class="tile"><div class="v" id="kObrasPorIniciar">‚Äî</div><div class="t">Obras por Iniciar</div></div>

      <!-- 4) Obras en proceso de Selecci√≥n -->
      <div class="tile"><div class="v" id="kObrasProcSel">‚Äî</div><div class="t">Obras en proceso de Selecci√≥n</div></div>

      <!-- 5) Exp. Concluidos -->
      <div class="tile"><div class="v" id="kExpConcluidos">‚Äî</div><div class="t">Exp. Concluidos</div></div>

      <!-- 6) Exp. en Elaboraci√≥n -->
      <div class="tile"><div class="v" id="kExpElab">‚Äî</div><div class="t">Exp. en Elaboraci√≥n</div></div>

      <!-- 7) Exp. en Proceso de Selecci√≥n -->
      <div class="tile"><div class="v" id="kExpProcSel">‚Äî</div><div class="t">Exp. en Proceso de Selecci√≥n</div></div>

      <!-- 8) Exp. por Convocar -->
      <div class="tile"><div class="v" id="kExpPorConvocar">‚Äî</div><div class="t">Exp. por Convocar</div></div>
    </section>
  </aside>

</div>

<script>
const FS_URL = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_Coord_MEF/FeatureServer/0";
const fmt = new Intl.NumberFormat('es-PE');

function esc(v){ return String(v).replaceAll("'", "''"); }
function cacheBust(){ return String(Date.now()); }
function buildWhereUbic(){
  const dep  = document.getElementById('selDep').value.trim();
  const prov = document.getElementById('selProv').value.trim();
  const dist = document.getElementById('selDist').value.trim();
  const parts = ["1=1"];
  if (dep)  parts.push(`departamento='${esc(dep)}'`);
  if (prov) parts.push(`provincia='${esc(prov)}'`);
  if (dist) parts.push(`distrito='${esc(dist)}'`);
  return parts.join(" AND ");
}
function esriPOST(url, paramsObj){
  const body = new URLSearchParams({ f:"json", returnGeometry:"false", ...paramsObj, __ts: cacheBust() });
  return fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
    body: body.toString(),
    cache:"no-store"
  }).then(r => { if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); })
    .then(j => { if(j.error){ console.error("ArcGIS:", j.error); throw new Error(j.error.message||"ArcGIS"); } return j; });
}
async function loadDistinct(field, where){
  const page = 2000; let offset = 0; const vals = new Set();
  while (true){
    const j = await esriPOST(FS_URL+"/query", {
      where: where || "1=1",
      outFields: field,
      orderByFields: field,
      returnDistinctValues: "true",
      resultRecordCount: page,
      resultOffset: offset
    });
    const rows = (j.features||[]).map(f => (f.attributes||{})[field]).filter(v => v!=null && v!=="");
    rows.forEach(v => vals.add(v));
    if (!j.exceededTransferLimit || rows.length < page) break;
    offset += page;
  }
  return [...vals];
}
async function updateKPIsTop(where){
  const totalProy = (await loadDistinct("producto_proyecto", where)).length;
  let agua=0, alc=0, pav=0, ver=0;
  try{
    const j = await esriPOST(FS_URL+"/query", {
      where,
      outStatistics: JSON.stringify([
        { statisticType:"sum", onStatisticField:"cnx_nuevas_agua",               outStatisticFieldName:"sAgua" },
        { statisticType:"sum", onStatisticField:"cnx_nuevas_alcantarillado_dse", outStatisticFieldName:"sAlc"  },
        { statisticType:"sum", onStatisticField:"final_pavimento_m2_monitoreo",  outStatisticFieldName:"sPav"  },
        { statisticType:"sum", onStatisticField:"final_vereda_m2_monitoreo",     outStatisticFieldName:"sVer"  }
      ])
    });
    const a = (j.features?.[0]?.attributes) || {};
    agua = Number(a.sAgua||0); alc = Number(a.sAlc||0);
    pav  = Number(a.sPav||0);  ver  = Number(a.sVer||0);
    if(agua===0 && alc===0 && pav===0 && ver===0) throw new Error("all-zero");
  }catch(e){
    let offset=0, page=2000;
    while(true){
      const j2 = await esriPOST(FS_URL+"/query", {
        where,
        outFields:"cnx_nuevas_agua,cnx_nuevas_alcantarillado_dse,final_pavimento_m2_monitoreo,final_vereda_m2_monitoreo",
        resultRecordCount:page, resultOffset:offset
      });
      const feats = j2.features||[];
      for(const f of feats){
        const at=f.attributes||{};
        agua += Number(at.cnx_nuevas_agua)||0;
        alc  += Number(at.cnx_nuevas_alcantarillado_dse)||0;
        pav  += Number(at.final_pavimento_m2_monitoreo)||0;
        ver  += Number(at.final_vereda_m2_monitoreo)||0;
      }
      if(!j2.exceededTransferLimit || feats.length<page) break;
      offset += page;
    }
  }
  document.getElementById('kpiCount').textContent = fmt.format(totalProy);
  document.getElementById('kpiAgua').textContent  = fmt.format(agua);
  document.getElementById('kpiAlc').textContent   = fmt.format(alc);
  document.getElementById('kpiPav').textContent   = fmt.format(pav);
  document.getElementById('kpiVer').textContent   = fmt.format(ver);
}
function IN(list){ return list.map(v=>`'${esc(v)}'`).join(","); }
async function countDistinctProducto(where){ return (await loadDistinct("producto_proyecto", where)).length; }
async function updateBottom(whereBase){
  const OBRA = ["OBRA (SALDO)","OBRA"];
  const EXP  = ["EXPEDIENTE TECNICO (SALDO)","OBRA (Expediente Saldo)","EXPEDIENTE TECNICO"];
  const W = (...conds)=> [whereBase, ...conds.filter(Boolean)].join(" AND ");
  const queries = {
    obrasConcluidas: W(`etapa IN (${IN(OBRA)})`, `estado IN ('Transferencia','Post Ejecuci√≥n','Concluido')`),
    expConcluidos:   W(`etapa IN (${IN(EXP)})`,  `estado IN ('Concluido')`),
    obrasEjec:       W(`etapa IN (${IN(OBRA)})`, `estado IN ('En Ejecuci√≥n')`),
    expElab:         W(`etapa IN (${IN(EXP)})`,  `estado IN ('En elaboraci√≥n')`),
    obrasPorIniciar: W(`etapa IN (${IN(OBRA)})`, `estado IN ('Actos Previos')`, `subestado = 'Por Iniciar'`),
    expProcSel:      W(`etapa IN (${IN(EXP)})`,  `estado IN ('Actos Previos')`, `subestado = 'Proceso de Selecci√≥n'`),
    obrasProcSel:    W(`etapa IN (${IN(OBRA)})`, `estado IN ('Actos Previos')`, `subestado = 'Proceso de Selecci√≥n'`),
    expPorConvocar:  W(`etapa IN (${IN(EXP)})`,  `estado IN ('Actos Previos')`, `subestado = 'Por Convocar'`)
  };
  const [n1,n2,n3,n4,n5,n6,n7,n8] = await Promise.all([
    countDistinctProducto(queries.obrasConcluidas),
    countDistinctProducto(queries.expConcluidos),
    countDistinctProducto(queries.obrasEjec),
    countDistinctProducto(queries.expElab),
    countDistinctProducto(queries.obrasPorIniciar),
    countDistinctProducto(queries.expProcSel),
    countDistinctProducto(queries.obrasProcSel),
    countDistinctProducto(queries.expPorConvocar),
  ]);
  document.getElementById('kObrasConcluidas').textContent = fmt.format(n1);
  document.getElementById('kExpConcluidos').textContent   = fmt.format(n2);
  document.getElementById('kObrasEjec').textContent       = fmt.format(n3);
  document.getElementById('kExpElab').textContent         = fmt.format(n4);
  document.getElementById('kObrasPorIniciar').textContent = fmt.format(n5);
  document.getElementById('kExpProcSel').textContent      = fmt.format(n6);
  document.getElementById('kObrasProcSel').textContent    = fmt.format(n7);
  document.getElementById('kExpPorConvocar').textContent  = fmt.format(n8);
}

/* ===== Mapa + filtros ===== */
require([
  "esri/Map","esri/views/MapView","esri/layers/FeatureLayer","esri/widgets/ScaleBar"
], (Map,MapView,FeatureLayer,ScaleBar)=>{

  const map = new Map({ basemap:"osm" });
  const view = new MapView({ container:"viewDiv", map, center:[-75.2,-9.3], zoom:5 });

  /* Ocultar cabecera nativa del popup */
  view.popup.title = "";
  try{ view.popup.visibleElements = { title:false }; }catch(_){}

  function money(n){ return new Intl.NumberFormat("es-PE",{maximumFractionDigits:0}).format(Number(n||0)); }
  function intfmt(n){ return new Intl.NumberFormat("es-PE",{maximumFractionDigits:0}).format(Number(n||0)); }
  function safe(s){ return (s==null||s==="") ? "‚Äî" : String(s); }

  const layer = new FeatureLayer({
    url: FS_URL, outFields:["*"], title:"Proyectos MEF",
    renderer:{
      type:"simple",
      symbol:{ type:"simple-marker", color:[31,112,102,0.95], size:6, outline:{ color:[255,255,255,140], width:0.5 } }
    },
    popupEnabled:true,
    popupTemplate:{
      title: "",
      outFields:["*"],
      content: function(e){
        const a = e.graphic.attributes || {};
        const prog = safe(a.programa);
        const dep  = safe(a.departamento);
        const prov = safe(a.provincia);
        const dist = safe(a.distrito);
        const pim  = "S/. " + money(a.monto_pim);
        const dev  = "S/. " + money(a.monto_devengado);
        const agua = intfmt(a.cnx_nuevas_agua);
        const alc  = intfmt(a.cnx_nuevas_alcantarillado_dse);
        const etapa= safe(a.etapa);
        const estado=safe(a.estado);
        const url1 = a.url_ssp && String(a.url_ssp).trim() ? String(a.url_ssp).trim() : null;
        const url2 = a.url_pdf && String(a.url_pdf).trim() ? String(a.url_pdf).trim() : null;

        const btn1 = url1 ? `<a class="pop-btn" href="${url1}" target="_blank" rel="noopener"><span class="link-ic">üîó</span> Detalle del Proyecto</a>` : "";
        const btn2 = url2 ? `<a class="pop-btn" href="${url2}" target="_blank" rel="noopener"><span class="link-ic">üìÑ</span> Ayuda Memoria (PDF)</a>` : "";

        return `
          <div class="pop-card">
            <div class="pop-hdr">${a.producto_proyecto_nombre ? a.producto_proyecto_nombre : "Proyecto"}</div>
            <div class="pop-grid">
              <div class="lbl">Programa</div><div class="val">${prog}</div>
              <div class="lbl">Departamento</div><div class="val">${dep}</div>
              <div class="lbl">Provincia</div><div class="val">${prov}</div>
              <div class="lbl">Distrito</div><div class="val">${dist}</div>
              <div class="lbl">Monto PIM</div><div class="val">${pim}</div>
              <div class="lbl">Monto devengado</div><div class="val">${dev}</div>
              <div class="lbl">Cnx. nuevas de agua</div><div class="val">${agua}</div>
              <div class="lbl">Cnx. nuevas de alcantarillado</div><div class="val">${alc}</div>
            </div>
            <div class="pop-chipwrap">
              <div class="chip">Etapa: ${etapa}</div>
              <div class="chip">Estado: ${estado}</div>
            </div>
            <div class="pop-actions">
              ${btn1}${btn2}
            </div>
          </div>
        `;
      }
    }
  });

  map.add(layer);
  view.ui.add(new ScaleBar({view,unit:"metric"}),"bottom-left");

  const selDep  = document.getElementById('selDep');
  const selProv = document.getElementById('selProv');
  const selDist = document.getElementById('selDist');
  const btnClear= document.getElementById('btnClear');

  async function refreshDep(){
    selDep.innerHTML = `<option value="">(Todos)</option>`;
    const deps = await loadDistinct("departamento");
    deps.forEach(v => selDep.insertAdjacentHTML("beforeend", `<option>${v}</option>`));
    selProv.innerHTML = `<option value="">(Todos)</option>`; selProv.disabled = true;
    selDist.innerHTML = `<option value="">(Todos)</option>`; selDist.disabled = true;
  }
  async function refreshProv(){
    const dep = selDep.value.trim();
    selProv.innerHTML = `<option value="">(Todos)</option>`;
    selDist.innerHTML = `<option value="">(Todos)</option>`; selDist.disabled = true;
    if(!dep){ selProv.disabled=true; applyAll(); return; }
    const provs = await loadDistinct("provincia", `departamento='${esc(dep)}'`);
    provs.forEach(v => selProv.insertAdjacentHTML("beforeend", `<option>${v}</option>`));
    selProv.disabled = false;
  }
  async function refreshDist(){
    const dep = selDep.value.trim();
    const prov= selProv.value.trim();
    selDist.innerHTML = `<option value="">(Todos)</option>`;
    if(!dep || !prov){ selDist.disabled = true; applyAll(); return; }
    const dists = await loadDistinct("distrito", `departamento='${esc(dep)}' AND provincia='${esc(prov)}'`);
    dists.forEach(v => selDist.insertAdjacentHTML("beforeend", `<option>${v}</option>`));
    selDist.disabled = false;
  }

  async function applyAll(){
    const where = buildWhereUbic();
    layer.definitionExpression = where;
    await Promise.all([ updateKPIsTop(where), updateBottom(where) ]);
  }

  selDep.addEventListener("change", async ()=>{ await refreshProv(); applyAll(); });
  selProv.addEventListener("change", async ()=>{ await refreshDist(); applyAll(); });
  selDist.addEventListener("change", ()=>{ applyAll(); });
  btnClear.addEventListener("click", async ()=>{
    selDep.value = ""; await refreshProv();
    applyAll();
  });

  (async function init(){
    await refreshDep();
    applyAll();
  })();
});
</script>
</body>
</html>
