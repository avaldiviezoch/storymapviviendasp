<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Evolución del Avance Físico por Programa</title>
<style>
  :root{ --ink:#062e2b; --muted:#475569; --grid:#eef2f7; }

  html, body {
    height: 100%;
    width: 100%;
    margin: 0;
    background: #fff;
    color: var(--ink);
    font-family: system-ui, Segoe UI, Roboto, Arial;
    overflow: hidden;
  }

  .stage{
    height: 100dvh;
    height: 100vh;
    width: 100%;
    display: grid;
    grid-template-rows: min-content min-content 1fr;
    align-items: start;
    justify-items: stretch;
    padding: 0;
    box-sizing: border-box;
    gap: 8px;
  }

  h1{
    margin: 0;
    padding: 8px 10px;
    text-align: center;
    font-weight: 800;
    letter-spacing: .2px;
    font-size: clamp(18px, 2.6vw, 28px);
  }

  .legendBar{
    display:flex; justify-content:center; align-items:center; gap:14px;
    flex-wrap:wrap; min-height:32px; padding: 0 8px;
  }
  .leg-btn{
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
    border:1px solid #e5e7eb; border-radius:999px; cursor:pointer;
    user-select:none; background:#fff; font-weight:700; font-size:13px;
    transition:transform .06s ease, opacity .2s ease, background .2s;
    white-space: nowrap;
  }
  .leg-btn .swatch{ width:12px; height:12px; border-radius:50%; box-shadow:0 0 0 2px #fff inset, 0 0 0 1px #00000010 }
  .leg-btn[aria-pressed="false"]{ opacity:.35; background:#f8fafc; }

  .chartWrap{
    position:relative; overflow:hidden; border-radius:0;
    width:100%; height:100%;
  }
  canvas{ display:block; width:100%; height:100% }

  .empty{
    display:grid; place-items:center; height:100%;
    color:#64748b; font-size:clamp(13px,1.6vw,16px); padding: 12px; text-align:center;
  }

  /* Tooltip */
  .tip{
    position:absolute; pointer-events:none; background:#0b2532; color:#fff;
    padding:8px 10px; border-radius:10px; font-size:12px; line-height:1.25;
    box-shadow:0 10px 24px rgba(2,6,23,.18); opacity:0; transform:translate(-50%,-110%);
    transition:opacity .12s ease;
    max-width:min(320px, 60vw);
  }
  .tip h4{margin:0 0 6px 0; font-size:12px; letter-spacing:.02em; opacity:.9}
  .tip .row{display:flex; gap:10px; align-items:center; justify-content:space-between}
  .dot{width:10px;height:10px;border-radius:50%; display:inline-block}
  .tip .name{display:flex; align-items:center; gap:8px}
</style>
</head>
<body>
  <div class="stage">
    <h1>Evolución del Avance de Ejecución Física por Programa</h1>
    <div class="legendBar" id="legendBar" role="toolbar" aria-label="Filtrar por programa"></div>
    <div class="chartWrap" id="wrap" aria-live="polite">
      <canvas id="chart"></canvas>
      <div id="empty" class="empty" style="display:none">Sin datos que cumplan los filtros.</div>
      <div id="tip" class="tip" role="status"></div>
    </div>
  </div>

<script>
/* ---------- Config ---------- */
const LYR1 = "https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/story_monitoreo_inversiones/FeatureServer/1/query";
const LYR13= "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";

const WHERE_1  = "etapa IN ('OBRA','OBRA (SALDO)')";
const WHERE_13 = "monto_pim > 0 AND producto_proyecto IS NOT NULL AND producto_proyecto <> 2193247";

const BINS = [
  {label:"0",      match:(v)=> Number(v)===0},
  {label:"0–20",   match:(v)=> v>0   && v<20},
  {label:"20–40",  match:(v)=> v>=20 && v<40},
  {label:"40–60",  match:(v)=> v>=40 && v<60},
  {label:"60–80",  match:(v)=> v>=60 && v<80},
  {label:"80–100", match:(v)=> v>=80 && v<=100},
];

/* Colores distintos */
const COLORS = {
  PASLC:"#E69F00", // naranja
  PMIB: "#D55E00", // rojo
  PNSR: "#0072B2", // azul
  PNSU: "#009E73"  // verde
};
const FALLBACK_COLORS = ["#56B4E9","#F0E442","#CC79A7","#000000","#999999"];

/* Helpers de red y utilitarios */
async function fetchAllPOST(url, baseParams){
  const pageSize = 2000;
  let offset = 0, out = [];
  while(true){
    const params = new URLSearchParams({
      ...baseParams, returnGeometry:"false", f:"json",
      resultRecordCount: pageSize, resultOffset: offset
    });
    const res = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
      body: params.toString(),
      cache:"no-store"
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const j = await res.json();
    const feats = j.features ?? [];
    out.push(...feats.map(f=>f.attributes||{}));
    if(!j.exceededTransferLimit && feats.length < pageSize) break;
    offset += pageSize;
  }
  return out;
}
function toNumberSafe(x){ if (x==null) return NaN; return typeof x==="number"?x:parseFloat(String(x).replace(",", ".")); }
function binLabel(vRaw){
  const v = toNumberSafe(vRaw);
  if (!isFinite(v)) return null;
  for (const b of BINS){ if (b.match(v)) return b.label; }
  return null;
}
const colorFor = (prog, idx)=> COLORS[prog] || FALLBACK_COLORS[idx % FALLBACK_COLORS.length];

/* ---------- Data ---------- */
async function loadData(){
  const attrs13 = await fetchAllPOST(LYR13, {where: WHERE_13, outFields: "producto_proyecto"});
  const validIDs = new Set(attrs13.map(a=>a.producto_proyecto).filter(v=>v!=null));
  if (!validIDs.size) return [];
  const rows1 = await fetchAllPOST(LYR1, {where: WHERE_1, outFields: "icodunificado,programa,avancefisicoreal"});
  const filtered = rows1.filter(r => validIDs.has(r.icodunificado));

  const byProgram = new Map();
  for (const r of filtered){
    const prog = (r.programa ?? "").toString().trim();
    theBin = binLabel(r.avancefisicoreal);
    const bin = theBin;
    if (!prog || !bin) continue;
    if (!byProgram.has(prog)) byProgram.set(prog, new Map());
    const m = byProgram.get(prog);
    m.set(bin, (m.get(bin)||0)+1);
  }

  const series = [];
  for (const [prog, counts] of byProgram){
    series.push({ programa: prog, data: BINS.map(b => counts.get(b.label)||0) });
  }
  return series.sort((a,b)=> a.programa.localeCompare(b.programa,'es'));
}

/* ---------- Curvas suavizadas (Catmull–Rom → Bézier) ---------- */
function drawCRSpline(ctx, pts){
  // pts: [{x,y}, ...] con length >= 2
  if (pts.length < 2){ return; }
  const p = (i)=> pts[Math.max(0, Math.min(pts.length-1, i))];
  ctx.moveTo(pts[0].x, pts[0].y);
  for (let i=0; i<pts.length-1; i++){
    const p0 = p(i-1), p1 = p(i), p2 = p(i+1), p3 = p(i+2);
    // Catmull-Rom to cubic Bézier (tension=0.5)
    const t = 0.5;
    const cp1x = p1.x + (p2.x - p0.x) * (t/6);
    const cp1y = p1.y + (p2.y - p0.y) * (t/6);
    const cp2x = p2.x - (p3.x - p1.x) * (t/6);
    const cp2y = p2.y - (p3.y - p1.y) * (t/6);
    ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
  }
}

/* ---------- Chart ---------- */
function makeChart(series){
  const wrap = document.getElementById("wrap");
  const canvas = document.getElementById("chart");
  const ctx = canvas.getContext("2d");
  const empty = document.getElementById("empty");
  const legendBar = document.getElementById("legendBar");
  const tip = document.getElementById("tip");

  if(!series.length){ empty.style.display="grid"; return; }
  empty.style.display="none";

  const visible = new Map(series.map(s=>[s.programa,true]));
  legendBar.innerHTML="";
  series.forEach((s,i)=>{
    const btn=document.createElement("button");
    btn.className="leg-btn"; btn.type="button";
    btn.setAttribute("aria-pressed","true");
    btn.innerHTML=`<span class="swatch" style="background:${colorFor(s.programa,i)}"></span>${s.programa}`;
    btn.onclick=()=>{ const cur=visible.get(s.programa); visible.set(s.programa,!cur);
      btn.setAttribute("aria-pressed",String(!cur)); draw(); };
    legendBar.appendChild(btn);
  });

  // Para hit-test del tooltip
  let hitPoints = []; // {x,y,r, programa, binLabel, value, color}

  function draw(){
    const dpr=Math.max(1,window.devicePixelRatio||1);
    const W=wrap.clientWidth,H=wrap.clientHeight;
    canvas.width=W*dpr; canvas.height=H*dpr;
    canvas.style.width=W+"px"; canvas.style.height=H+"px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,W,H);
    hitPoints = [];

    const pad={t:42,r:14,b:44,l:60};
    const xStep=(W-pad.l-pad.r)/(BINS.length-1);
    const yMaxData=Math.max(1,...series.flatMap(s=>visible.get(s.programa)?s.data:[0]));
    const yMax=Math.min(300,Math.max(5,Math.ceil(yMaxData/5)*5));
    const x=i=>pad.l+xStep*i, y=v=>pad.t+(H-pad.t-pad.b)*(1-v/yMax);

    // eje Y + X
    ctx.strokeStyle="#e5e7eb"; ctx.beginPath(); ctx.moveTo(pad.l,y(0)); ctx.lineTo(W-pad.r,y(0)); ctx.stroke();
    ctx.textAlign="right"; ctx.textBaseline="middle"; ctx.fillStyle="#0b3b38"; ctx.font="12px system-ui";
    for(let t=0;t<=5;t++){ const val=Math.round(yMax/5*t), yy=y(val);
      ctx.strokeStyle="#eef2f7"; ctx.beginPath(); ctx.moveTo(pad.l,yy); ctx.lineTo(W-pad.r,yy); ctx.stroke();
      ctx.fillText(val,pad.l-8,yy); }
    ctx.textAlign="center"; ctx.textBaseline="top";
    BINS.forEach((b,i)=> ctx.fillText(b.label,x(i),y(0)+8));

    // series (líneas suavizadas + puntos)
    const POINT_R = 4; // un punto más grande que antes (era 3)
    series.forEach((s,idx)=>{
      if(!visible.get(s.programa)) return;
      const col=colorFor(s.programa,idx);

      // Construir puntos
      const pts = s.data.map((v,i)=>({ x:x(i), y:y(v), bin:BINS[i].label, val:v, programa:s.programa, color:col }));

      // Línea suavizada
      ctx.strokeStyle=col; ctx.lineWidth=2; ctx.beginPath();
      drawCRSpline(ctx, pts);
      ctx.stroke();

      // Puntos y registro hit-test
      ctx.fillStyle=col;
      pts.forEach(p=>{
        ctx.beginPath(); ctx.arc(p.x,p.y,POINT_R,0,2*Math.PI); ctx.fill();
        hitPoints.push({x:p.x, y:p.y, r:Math.max(POINT_R+6,10), programa:p.programa, binLabel:p.bin, value:p.val, color:p.color});
      });
    });
  }

  // Tooltip interactivo
  function handleMove(ev){
    const rect = canvas.getBoundingClientRect();
    const x = (ev.clientX - rect.left);
    const y = (ev.clientY - rect.top);
    let best=null, bestD=Infinity;
    for(const p of hitPoints){
      const dx = x - p.x, dy = y - p.y;
      const d2 = dx*dx + dy*dy;
      if (d2 < (p.r*p.r) && d2 < bestD){ best=p; bestD=d2; }
    }
    if(best){
      tip.innerHTML = `
        <h4>${best.programa}</h4>
        <div class="row">
          <span class="name"><span class="dot" style="background:${best.color}"></span>Rango</span>
          <strong>${best.binLabel}</strong>
        </div>
        <div class="row">
          <span>Conteo</span>
          <strong>${best.value}</strong>
        </div>`;
      tip.style.left = `${x}px`;
      tip.style.top  = `${y}px`;
      tip.style.opacity = 1;
    }else{
      tip.style.opacity = 0;
    }
  }
  function handleLeave(){ tip.style.opacity = 0; }

  draw();
  window.addEventListener("resize",draw,{passive:true});
  canvas.addEventListener("mousemove", handleMove, {passive:true});
  canvas.addEventListener("mouseleave", handleLeave, {passive:true});
}

/* ---------- Run ---------- */
(async function(){
  try{
    const series = await loadData();
    makeChart(series);
  }catch(e){
    console.error(e);
    const empty = document.getElementById("empty");
    empty.style.display = "grid";
    empty.textContent = "Error al cargar datos";
  }
})();
</script>
</body>
</html>
