<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bubble chart — Gasto vs Acceso Agua (agregado por MACROZONA)</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#fff;font-family:system-ui,Arial}
    #chart{height:100vh;width:100vw}
  </style>
</head>
<body>
<div id="chart"></div>

<script>
/* ======== Servicio y layers ======== */
const SERVICE_BASE = "https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/Mapa_coropletico_2/FeatureServer";
const LYR_X    = 5; // eje X   (gasto S/)
const LYR_Y    = 3; // eje Y   (población con acceso a agua)
const LYR_SIZE = 4; // tamaño  (población ENAPRES, miles)

const YEAR_START = 2011;
const YEAR_END   = 2024;

/* ======== Columnas por región (keys exactos del servicio) ======== */
const REGION_COLS = [
  { key:'amazonas', display:'Amazonas' },
  { key:'ancash', display:'Áncash' },
  { key:'apurimac', display:'Apurímac' },
  { key:'arequipa', display:'Arequipa' },
  { key:'ayacucho', display:'Ayacucho' },
  { key:'cajamarca', display:'Cajamarca' },
  { key:'provincia_constitucional_del_ca', display:'PROVINCIA CONSTITUCIONAL DEL CALLAO' },
  { key:'cusco', display:'Cusco' },
  { key:'huancavelica', display:'Huancavelica' },
  { key:'huanuco', display:'Huánuco' },
  { key:'ica', display:'Ica' },
  { key:'junin', display:'Junín' },
  { key:'la_libertad', display:'La Libertad' },
  { key:'lambayeque', display:'Lambayeque' },
  { key:'lima', display:'Lima' },
  { key:'loreto', display:'Loreto' },
  { key:'madre_de_dios', display:'Madre de Dios' },
  { key:'moquegua', display:'Moquegua' },
  { key:'pasco', display:'Pasco' },
  { key:'piura', display:'Piura' },
  { key:'puno', display:'Puno' },
  { key:'san_martin', display:'San Martín' },
  { key:'tacna', display:'Tacna' },
  { key:'tumbes', display:'Tumbes' },
  { key:'ucayali', display:'Ucayali' }
];

/* ======== Mapeo Región -> Macrozona (sumar por macrozona) ======== */
/* Lo que no esté en esta lista caerá en "OTRAS" (ajústalo si quieres). */
const MACROZONA_BY_DISPLAY = {
  'Amazonas': 'NORTE',
  'Áncash': 'CENTRO',
  'Apurímac': 'SUR',
  'Arequipa': 'SUR',
  'Ayacucho': 'SUR',
  'Cajamarca': 'NORTE',
  'PROVINCIA CONSTITUCIONAL DEL CALLAO': 'LIMA Y CALLAO',
  'Cusco': 'SUR',
  'Huancavelica': 'SUR',
  'Huánuco': 'CENTRO',
  'Ica': 'SUR',
  'Junín': 'CENTRO',
  'La Libertad': 'NORTE',
  'Lambayeque': 'NORTE',
  'Lima': 'LIMA Y CALLAO',
  'Loreto': 'NORTE',
  'Madre de Dios': 'SUR',
  'Moquegua': 'SUR',
  'Pasco': 'CENTRO',
  'Piura': 'NORTE',
  // Sugerencias (ajústalas si corresponde):
  'Puno': 'SUR',
  'San Martín': 'NORTE',
  'Tacna': 'SUR',
  'Tumbes': 'NORTE',
  'Ucayali': 'CENTRO' // muchas clasificaciones ponen Ucayali en Oriente; cámbialo si necesitas
};

const chart = echarts.init(document.getElementById('chart'));

/* ======== Helpers ======== */
function qs(url, params) {
  return url + "?" + new URLSearchParams(params).toString();
}
async function fetchTable(layerId) {
  const url = qs(`${SERVICE_BASE}/${layerId}/query`, {
    where: "1=1",
    outFields: "*",
    returnGeometry: "false",
    orderByFields: "anio ASC",
    f: "json"
  });
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error(`HTTP ${res.status} al consultar layer ${layerId}`);
  const json = await res.json();
  if (json.error) throw new Error(json.error.message || `Error del servicio en layer ${layerId}`);
  const feats = json.features || [];
  const byYear = new Map();
  for (const f of feats) {
    const a = (f.attributes || {});
    const yrRaw = a.anio;
    const yr = typeof yrRaw === 'string' ? parseInt(yrRaw, 10) : Number(yrRaw);
    if (Number.isFinite(yr)) byYear.set(yr, a);
  }
  return byYear;
}
function extent(arr) {
  let min = +Infinity, max = -Infinity;
  for (const v of arr) {
    if (Number.isFinite(v)) { if (v < min) min = v; if (v > max) max = v; }
  }
  if (!Number.isFinite(min) || !Number.isFinite(max)) return [0,1];
  if (min === max) return [0, max || 1];
  return [min, max];
}
function makeSizeFn(values) {
  const [, mx] = extent(values);
  return function sizeFn(x) {
    const v = Math.max(0, Number(x)||0);
    const t = mx > 0 ? (v / mx) : 0;
    return (Math.sqrt(t) + 0.10) * 70; // tamaño relativo de burbuja
  };
}

/* ======== Run ======== */
(async function run(){
  try {
    chart.showLoading({ text: 'Cargando datos…' });
    const [xByYear, yByYear, sByYear] = await Promise.all([
      fetchTable(LYR_X),    // gasto
      fetchTable(LYR_Y),    // acceso agua
      fetchTable(LYR_SIZE)  // ENAPRES (miles)
    ]);

    // Años
    const years = [];
    for (let y = YEAR_START; y <= YEAR_END; y++) years.push(y);

    // Prepara tamaño (usar todas las sums por macrozona para escalar)
    const allMacroSizes = [];

    // Construye options del timeline, agregando por macrozona
    const options = [];
    for (const year of years) {
      const rowX = xByYear.get(year) || {};
      const rowY = yByYear.get(year) || {};
      const rowS = sByYear.get(year) || {};

      // Acumulador por macrozona
      const acc = new Map(); // macro -> {xSum,ySum,sSum}
      function addToMacro(macro, xVal, yVal, sVal) {
        if (!acc.has(macro)) acc.set(macro, {x:0,y:0,s:0});
        const obj = acc.get(macro);
        obj.x += (Number(xVal) || 0);
        obj.y += (Number(yVal) || 0);
        obj.s += (Number(sVal) || 0);
      }

      // Recorre todas las regiones, agrega a su macrozona
      for (const {key, display} of REGION_COLS) {
        const macro = MACROZONA_BY_DISPLAY[display] || 'OTRAS';
        const xVal = rowX[key];
        const yVal = rowY[key];
        const sVal = rowS[key];
        // Si X y Y son números válidos, se toma el punto; (sVal puede ser 0)
        if (Number.isFinite(Number(xVal)) && Number.isFinite(Number(yVal))) {
          addToMacro(macro, xVal, yVal, sVal);
        }
      }

      // Convierte acumulaciones a puntos [x,y,size,label]
      const points = [];
      for (const [macro, sums] of acc.entries()) {
        points.push([sums.x, sums.y, sums.s, macro]);
        allMacroSizes.push(sums.s);
      }

      options.push({
        title: { show: true, text: String(year) },
        series: [{
          name: String(year),
          type: 'scatter',
          data: points,
          itemStyle: { opacity: 0.9 },
          symbolSize: function (val) { return sizeFn(val[2]); },
          label: {
            show: true,
            formatter: p => p.value[3], // macrozona
            position: 'right',
            fontSize: 11,
            color: '#111'
          }
        }]
      });
    }

    // Función de tamaño usando todas las sums (para escala consistente)
    const sizeFn = makeSizeFn(allMacroSizes);

    // Colorear por macrozona
    const macroCats = ['NORTE','CENTRO','SUR','LIMA Y CALLAO','OTRAS'];
    const macroColors = {
      'NORTE': '#2f7ed8',
      'CENTRO': '#8bbc21',
      'SUR': '#910000',
      'LIMA Y CALLAO': '#1aadce',
      'OTRAS': '#777777'
    };
    const colorList = macroCats.map(m => macroColors[m]);

    const option = {
      baseOption: {
        timeline: {
          axisType: 'category',
          orient: 'vertical',
          autoPlay: true,
          inverse: true,
          playInterval: 1200,
          right: 0,
          top: 20,
          bottom: 20,
          width: 55,
          symbol: 'none',
          checkpointStyle: { borderWidth: 2 },
          controlStyle: { showNextBtn: false, showPrevBtn: false },
          data: years
        },
        title: [
          {
            text: years[0],
            textAlign: 'center',
            left: '63%',
            top: '55%',
            textStyle: { fontSize: 72, fontWeight: 600, color: '#e5e7eb' }
          },
          {
            text: 'Gasto (S/) vs Población con acceso a agua — tamaño: Población (miles) — agregado por MACROZONA',
            left: 'center',
            top: 8,
            textStyle: { fontWeight: '600', fontSize: 16 }
          }
        ],
        tooltip: {
          padding: 6,
          borderWidth: 1,
          formatter: function (obj) {
            const v = obj.value; // [x,y,s,macro]
            return (
              `<b>${v[3]}</b><br>` +
              `Acceso a agua (suma): <b>${Number(v[1]).toLocaleString('es-PE')}</b><br>` +
              `Gasto (S/) (suma): <b>${Number(v[0]).toLocaleString('es-PE')}</b><br>` +
              `Población (miles) (suma): <b>${Number(v[2]).toLocaleString('es-PE')}</b>`
            );
          }
        },
        grid: { top: 80, left: 40, right: 110, bottom: 40, containLabel: true },
        xAxis: {
          type: 'log',
          name: 'Gasto (S/)',
          min: 300, max: 200000000, // ajusta si lo ves necesario
          nameGap: 25,
          nameLocation: 'middle',
          nameTextStyle: { fontSize: 14 },
          splitLine: { show: false },
          axisLabel: { formatter: (v) => new Intl.NumberFormat('es-PE').format(v) }
        },
        yAxis: {
          type: 'value',
          name: 'Población con acceso al agua (suma)',
          nameTextStyle: { fontSize: 14 },
          splitLine: { show: true },
          axisLabel: { formatter: (v) => new Intl.NumberFormat('es-PE').format(v) }
        },
        visualMap: [{
          show: false,
          dimension: 3,
          categories: macroCats,
          inRange: { color: colorList }
        }],
        series: [{
          type: 'scatter',
          data: [],
          symbolSize: function (val) { return sizeFn(val[2]); },
          label: {
            show: true,
            formatter: p => p.value[3],
            position: 'right',
            fontSize: 11,
            color: '#111'
          }
        }],
        animationDurationUpdate: 1000,
        animationEasingUpdate: 'quinticInOut'
      },
      options
    };

    chart.hideLoading();
    chart.setOption(option);
    window.addEventListener('resize', () => chart.resize());

  } catch (err) {
    console.error(err);
    chart.hideLoading();
    chart.setOption({
      title: { text:'Error al cargar datos', left:'center' },
      graphic: {
        type:'text', left:'center', top:'middle',
        style:{ text: (err && err.message) ? err.message : 'Fallo de carga.\nRevisa URL, permisos (token) o campos.', fontSize: 14 }
      }
    });
  }
})();
</script>
</body>
</html>
