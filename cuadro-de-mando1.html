<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tabla MVCS — PIM/Devengado por Pliego y Unidad Ejecutora</title>
<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --bg:#ffffff; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --chip-ok:#16a34a; --chip-mid:#f59e0b; --chip-bad:#ef4444; --accent:#0ea5e9;

    --w-name:280px;
    --w-num:130px;
    --w-pct:110px;

    --fs-body:13.5px;
    --fs-head:14px;
  }

  html,body{
    height:100%;
    margin:0;
    background:transparent;
    font-family:system-ui,Segoe UI,Roboto,Arial;
    color:var(--ink);
    overflow:hidden;
  }

  .wrap{
    height:100%;
    overflow:hidden;
  }

  .card{
    height:100%;
    width:100%;
    max-width:1400px;
    margin:0 auto;
    background:var(--bg);
    border-radius:12px;
    box-shadow:0 8px 24px rgba(2,6,23,.06);
    overflow:hidden;
    position:relative;
    display:flex;
    flex-direction:column;
  }

  .header{
    flex:0 0 auto;
    text-align:center;
    padding:8px 10px 6px;
    border-bottom:1px solid var(--line)
  }
  .title{
    margin:0;
    font-weight:800;
    font-size:clamp(15px,2vw,20px);
    letter-spacing:.2px
  }
  .legend{
    margin-top:4px;
    display:flex;align-items:center;justify-content:center;gap:12px;
    font-size:12px;color:#111827
  }
  .legend .dot{width:.58rem;height:.58rem;border-radius:999px;display:inline-block;margin-right:.35rem}

  .btnCSV{
    position:absolute;top:8px;right:8px;
    display:inline-grid;place-items:center;
    width:26px;height:26px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;color:#64748b;
    cursor:pointer;font-size:15px;line-height:1;opacity:.65
  }
  .btnCSV:hover{opacity:1;color:#0f172a;border-color:#cbd5e1}
  .btnCSV:focus{outline:2px solid #bae6fd;outline-offset:2px}

  .table-wrap{
    flex:1 1 auto;
    min-height:0;
    overflow:auto;
    -webkit-overflow-scrolling:touch;
    max-width:100%;
  }
  .table{
    width:100%;
    border-collapse:separate;border-spacing:0;
    table-layout:fixed;
    font-size:var(--fs-body);
  }

  thead th{
    position:sticky;top:0;z-index:40;
    background:linear-gradient(180deg,#111827 0%,#374151 100%);
    color:#fff;text-align:center;font-weight:800;
    padding:8px 6px;
    border-bottom:2px solid #0b1220;
    font-size:var(--fs-head);
  }

  thead th:first-child{position:sticky;left:0;z-index:50;text-align:left}

  tbody tr.group>th{
    position:sticky;left:0;z-index:45;
    background:#f8fafc;
    border-bottom:1px solid var(--line);
    text-align:left;
    font-weight:800;
  }
  tbody tr.item>td:first-child{
    position:sticky;left:0;z-index:44;
    background:#fff;
    text-align:left;
  }

  thead th:first-child,
  tbody tr.group>th,
  tbody tr.item>td:first-child{
    box-shadow:6px 0 8px -6px rgba(0,0,0,.18);
  }

  .table th+th,.table td+td{border-left:1px solid var(--line)}
  thead th, tbody td, tbody th{line-height:1.2}
  tbody td,tbody th{
    padding:7px 6px;
    border-bottom:1px solid var(--line);
    background:#fff;
    box-sizing:border-box;
    vertical-align:middle;
  }

  .num{ text-align:right; white-space:nowrap; font-variant-numeric:tabular-nums; }
  .pct{ text-align:center; white-space:nowrap; font-variant-numeric:tabular-nums; }
  .dot{
    display:inline-block;
    width:.58rem;
    height:.58rem;
    border-radius:999px;
    vertical-align:-.08rem;
    margin-right:.32rem
  }
  .ok{background:var(--chip-ok)}
  .mid{background:var(--chip-mid)}
  .bad{background:var(--chip-bad)}

  /* botón que expande/colapsa */
  .btn{
    border:0;
    background:transparent;
    font-weight:800;
    cursor:pointer;
    padding:4px 0;
    border-radius:8px;
    text-align:left;
    line-height:1.3;
    color:var(--ink);
    display:inline-flex;
    align-items:flex-start;
    gap:6px;
    flex-wrap:nowrap;
    max-width:100%;
  }

  /* contenedor de la celda del pliego:
     izquierda (chev + texto)
     derecha (botón info animado)
  */
  .groupHead{
    display:flex;
    align-items:center;            /* centra vertical todo */
    justify-content:space-between; /* texto izq, botón info der */
    gap:8px;
    flex-wrap:nowrap;
  }

  .groupLeft{
    display:inline-flex;
    align-items:flex-start;
    gap:6px;
    max-width:calc(var(--w-name) - 60px); /* deja sitio al botón info */
  }

  /* === Botón "Más info" con animación estilo GIF === */
  .infoBtn{
    flex:0 0 auto;
    position:relative;
    width:32px;
    height:32px;
    border-radius:8px;
    background:radial-gradient(circle at 30% 30%, #38bdf8 0%, #0284c7 60%, #01497a 100%);
    border:1px solid rgba(255,255,255,.35);
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    text-decoration:none;
    line-height:1;
    box-shadow:0 0 12px rgba(56,189,248,.7),0 8px 18px rgba(2,132,199,.45);
    overflow:hidden;
  }

  /* halo/pulso como glow animado alrededor del botón */
  .infoBtn::after{
    content:"";
    position:absolute;
    inset:-4px;
    border-radius:10px;
    background:radial-gradient(circle,#38bdf8 0%,rgba(56,189,248,0)70%);
    opacity:.4;
    filter:blur(6px);
    animation:haloPulse 2s ease-in-out infinite;
    pointer-events:none;
  }
  @keyframes haloPulse{
    0%  {opacity:.35; filter:blur(6px);}
    50% {opacity:.75; filter:blur(10px);}
    100%{opacity:.35; filter:blur(6px);}
  }

  /* Contenedor interno del icono animado */
  .infoIconWrap{
    position:relative;
    width:18px;
    height:18px;
  }

  /* Cada "flecha externa" es un svg blanco con glow */
  .infoArrow{
    position:absolute;
    left:0;
    top:0;
    width:18px;
    height:18px;
    opacity:0;
    filter:drop-shadow(0 0 4px rgba(255,255,255,.9))
            drop-shadow(0 0 8px rgba(56,189,248,.8));
    animation:infoDrip 1.8s ease-in-out infinite;
  }
  .infoArrow:nth-child(2){animation-delay:.22s}
  .infoArrow:nth-child(3){animation-delay:.44s}

  /* animación tipo "sube y aparece / baja y desaparece"
     similar a las flechitas naranjas de goteo */
  @keyframes infoDrip{
    0%   {transform:translateY(6px) scale(.9); opacity:0}
    20%  {transform:translateY(0) scale(1);   opacity:1}
    60%  {transform:translateY(-6px) scale(1.05); opacity:.95}
    100% {transform:translateY(-10px) scale(1.05); opacity:0}
  }

  /* SVG icon style */
  .infoArrow svg{
    width:18px;
    height:18px;
    stroke:#fff;
    stroke-width:2;
    stroke-linecap:round;
    stroke-linejoin:round;
    fill:none;
  }

  /* Flechitas animadas del botón colapsar */
  .chev{
    --chev-color:#ea580c;
    --chev-glow:rgba(234,88,12,.45);
    width:1.3rem;
    height:1.3rem;
    position:relative;
    display:inline-grid;
    place-items:center;
    flex-shrink:0;
    color:var(--chev-color)
  }
  .chev .arrow{
    position:absolute;
    width:16px;height:16px;
    opacity:0;
    filter:drop-shadow(0 5px 10px var(--chev-glow));
    animation:chevDrip 1.8s ease-in-out infinite
  }
  .chev .arrow:nth-child(2){animation-delay:.22s}
  .chev .arrow:nth-child(3){animation-delay:.44s}
  @keyframes chevDrip{
    0%{transform:translateY(-8px) scale(.95);opacity:0}
    20%{transform:translateY(-2px) scale(1);opacity:1}
    60%{transform:translateY(6px) scale(1.04);opacity:.95}
    100%{transform:translateY(12px) scale(1);opacity:0}
  }
  .btn:hover .chev{
    --chev-color:#ff6b1a;
    --chev-glow:rgba(255,107,26,.5)
  }
  .btn[aria-expanded="true"] .chev{
    --chev-color:#0ea5e9;
    --chev-glow:rgba(14,165,233,.45)
  }

  tfoot td{
    background:#f8fafc;
    font-weight:800;
    border-top:2px solid #94a3b8;
    padding:8px 10px
  }
  .footer{
    flex:0 0 auto;
    padding:8px 10px 10px;
    font-size:11.5px;
    color:var(--muted);
    border-top:1px solid var(--line);
    text-align:center
  }

  @media (max-width:1200px){
    :root{--w-name:250px;--w-num:120px;--w-pct:102px;--fs-body:12.8px;--fs-head:13.2px}
    .legend{font-size:11.5px}
  }
  @media (max-width:980px){
    :root{--w-name:220px;--w-num:112px;--w-pct:96px;--fs-body:12.2px;--fs-head:12.6px}
    .title{font-size:clamp(14px,2.2vw,18px)}
  }
  @media (max-width:760px){
    :root{--w-name:200px;--w-num:104px;--w-pct:92px;--fs-body:11.8px;--fs-head:12px}
    .legend{gap:10px}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <button id="btnCsv" class="btnCSV" title="Exportar a Excel" aria-label="Exportar a Excel">⤓</button>

    <div class="header">
      <h2 class="title">Ejecución presupuestal — MVCS (2025) por Pliego y Unidad Ejecutora</h2>
      <div class="legend">
        <span><span class="dot bad"></span><strong>Rojo</strong> &lt; 33%</span>
        <span><span class="dot mid"></span><strong>Ámbar</strong> 33%–67%</span>
        <span><span class="dot ok"></span><strong>Verde</strong> ≥ 67%</span>
      </div>
    </div>

    <div class="table-wrap">
      <table class="table" id="tbl" aria-label="Tabla de ejecución presupuestal">
        <colgroup>
          <col style="width:var(--w-name)">
          <col style="width:var(--w-num)">
          <col style="width:var(--w-num)">
          <col style="width:var(--w-pct)">
          <col style="width:var(--w-num)">
          <col style="width:var(--w-num)">
          <col style="width:var(--w-pct)">
          <col style="width:var(--w-num)">
          <col style="width:var(--w-num)">
          <col style="width:var(--w-pct)">
        </colgroup>
        <thead>
          <tr>
            <th>PLIEGO/EJECUTORAS</th>
            <th>PIM ACTIVIDADES<br/>Y PROYECTOS</th>
            <th>DEVENGADO</th>
            <th>AVANCE %</th>
            <th>PIM PROYECTO</th>
            <th>DEVENGADO<br/>PROYECTO</th>
            <th>AVANCE<br/>PROYECTO</th>
            <th>PIM ACTIVIDAD</th>
            <th>DEVENGADO<br/>ACTIVIDAD</th>
            <th>AVANCE<br/>ACTIVIDAD</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot id="tfoot"></tfoot>
      </table>
    </div>

    <div class="footer">Fuente: Ministerio de Economía y Finanzas — MEF · Portal de Datos Abiertos</div>
  </div>
</div>

<script>
/* Servicio y filtros */
const SERVICE="https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
const BASE_WHERE="sector_nombre = 'VIVIENDA CONSTRUCCION Y SANEAMIENTO' AND ano_eje = 2025";

/* Pliego con link adicional */
const INFO_LINKS={
  "MINISTERIO DE VIVIENDA, CONSTRUCCION Y SANEAMIENTO":
    "https://pportalgis.vivienda.gob.pe/pportal/apps/storymaps/stories/750c7c6b13bf477287b8db07c865f1b1"
};

const fmt=new Intl.NumberFormat('es-PE');
const pctStr=(r)=>isFinite(r)?(r*100).toFixed(2)+' %':'0.00 %';
function chipClass(r){
  const p=Number(r)*100;
  if(!isFinite(p))return'bad';
  if(p<33)return'bad';
  if(p<67)return'mid';
  return'ok';
}

function buildParams(extra){
  return new URLSearchParams({
    where:`${BASE_WHERE}${extra? ' AND '+extra:''}`,
    groupByFieldsForStatistics:"pliego_nombre,ejecutora_nombre",
    outStatistics:JSON.stringify([
      {statisticType:"sum",onStatisticField:"monto_pim",outStatisticFieldName:"sum_pim"},
      {statisticType:"sum",onStatisticField:"monto_devengado",outStatisticFieldName:"sum_dev"}
    ]),
    returnGeometry:"false", f:"json"
  }).toString();
}

async function queryStats(extra){
  const res=await fetch(`${SERVICE}?${buildParams(extra)}`,{cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  const json=await res.json();
  if(json.error) throw new Error(json.error.message||'Error servicio');
  return (json.features||[]).map(f=>{
    const a=f.attributes||{};
    return {
      pliego:String(a.pliego_nombre||'').trim()||'(Sin pliego)',
      ejecutora:String(a.ejecutora_nombre||'').trim()||'(Sin ejecutora)',
      pim:Number(a.sum_pim||0),
      dev:Number(a.sum_dev||0)
    };
  });
}

function mergeStats(total,proy,act){
  const key=r=>`${r.pliego}|||${r.ejecutora}`;
  const it=new Map(), ip=new Map(), ia=new Map();
  total.forEach(r=>it.set(key(r),r));
  proy.forEach(r=>ip.set(key(r),r));
  act.forEach(r=>ia.set(key(r),r));

  const rows=[...new Set([...it.keys(),...ip.keys(),...ia.keys()])].map(k=>{
    const t=it.get(k)||{}, p=ip.get(k)||{}, a=ia.get(k)||{};
    return {
      pliego:t.pliego||p.pliego||a.pliego||'',
      ejecutora:t.ejecutora||p.ejecutora||a.ejecutora||'',
      pim:t.pim||0,
      dev:t.dev||0,
      pim_proy:p.pim||0,
      dev_proy:p.dev||0,
      pim_act:a.pim||0,
      dev_act:a.dev||0
    };
  });

  const byP=new Map();
  for(const r of rows){
    if(!byP.has(r.pliego)) byP.set(r.pliego,[]);
    byP.get(r.pliego).push(r);
  }
  for(const arr of byP.values()){
    arr.sort((x,y)=>x.ejecutora.localeCompare(y.ejecutora,'es'));
  }
  return new Map([...byP.entries()].sort((a,b)=>a[0].localeCompare(b[0],'es')));
}

function addRow(tbody,cells,opts={}){
  const tr=document.createElement('tr');
  tr.className=opts.className||'';
  for(const c of cells){
    const el=document.createElement(c.header?'th':'td');
    if(c.cls) el.className=c.cls;
    el.innerHTML=c.html;
    tr.appendChild(el);
  }
  tbody.appendChild(tr);
}

function renderTable(grouped){
  const tbody=document.getElementById('tbody');
  tbody.innerHTML='';
  let tot={pim:0,dev:0,pim_proy:0,dev_proy:0,pim_act:0,dev_act:0};

  for(const [pliego,items] of grouped.entries()){
    const s=items.reduce((a,r)=>({
      pim:a.pim+r.pim,
      dev:a.dev+r.dev,
      pim_proy:a.pim_proy+r.pim_proy,
      dev_proy:a.dev_proy+r.dev_proy,
      pim_act:a.pim_act+r.pim_act,
      dev_act:a.dev_act+r.dev_act
    }),{pim:0,dev:0,pim_proy:0,dev_proy:0,pim_act:0,dev_act:0});

    tot.pim+=s.pim;
    tot.dev+=s.dev;
    tot.pim_proy+=s.pim_proy;
    tot.dev_proy+=s.dev_proy;
    tot.pim_act+=s.pim_act;
    tot.dev_act+=s.dev_act;

    const av   = s.pim>0      ? s.dev/s.pim           :0;
    const avp  = s.pim_proy>0 ? s.dev_proy/s.pim_proy :0;
    const ava  = s.pim_act>0  ? s.dev_act/s.pim_act   :0;

    const gid='g_'+Math.random().toString(36).slice(2,9);

    /* StoryMap solo para el Ministerio */
    let infoBtnHTML='';
    for(const key in INFO_LINKS){
      if(pliego.toUpperCase().startsWith(key)){
        const href=INFO_LINKS[key];
        infoBtnHTML=
          `<a class="infoBtn"
              href="${href}"
              target="_blank"
              rel="noopener"
              title="Más información"
              aria-label="Más información">
             <span class="infoIconWrap">
                <span class="infoArrow">
                  <svg viewBox="0 0 24 24">
                    <path d="M14 3h7v7"/>
                    <path d="M10 14 21 3"/>
                    <path d="M21 14v7h-7"/>
                    <path d="M3 10 14 21"/>
                  </svg>
                </span>
                <span class="infoArrow">
                  <svg viewBox="0 0 24 24">
                    <path d="M14 3h7v7"/>
                    <path d="M10 14 21 3"/>
                    <path d="M21 14v7h-7"/>
                    <path d="M3 10 14 21"/>
                  </svg>
                </span>
                <span class="infoArrow">
                  <svg viewBox="0 0 24 24">
                    <path d="M14 3h7v7"/>
                    <path d="M10 14 21 3"/>
                    <path d="M21 14v7h-7"/>
                    <path d="M3 10 14 21"/>
                  </svg>
                </span>
             </span>
           </a>`;
        break;
      }
    }

    /* celda izquierda del pliego */
    const groupCellHTML = `
      <div class="groupHead">
        <div class="groupLeft">
          <button class="btn subtle" aria-expanded="false" aria-controls="${gid}">
            <span class="chev" aria-hidden="true">
              <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 4v12"></path><path d="M8 12l4 4 4-4"></path></svg>
              <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 4v12"></path><path d="M8 12l4 4 4-4"></path></svg>
              <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 4v12"></path><path d="M8 12l4 4 4-4"></path></svg>
            </span>
            <span style="display:inline-block;white-space:normal;word-break:break-word;">
              ${pliego}
            </span>
          </button>
        </div>
        ${infoBtnHTML}
      </div>`;

    addRow(tbody,[
      {header:true,cls:'group',html:groupCellHTML},
      {html:fmt.format(s.pim),cls:'num'},
      {html:fmt.format(s.dev),cls:'num'},
      {html:`<span class="dot ${chipClass(av)}"></span>${pctStr(av)}`,cls:'pct'},
      {html:fmt.format(s.pim_proy),cls:'num'},
      {html:fmt.format(s.dev_proy),cls:'num'},
      {html:`<span class="dot ${chipClass(avp)}"></span>${pctStr(avp)}`,cls:'pct'},
      {html:fmt.format(s.pim_act),cls:'num'},
      {html:fmt.format(s.dev_act),cls:'num'},
      {html:`<span class="dot ${chipClass(ava)}"></span>${pctStr(ava)}`,cls:'pct'}
    ],{className:'group'});

    /* filas hijas */
    for(const r of items){
      const av2   = r.pim>0        ? r.dev/r.pim             :0;
      const avp2  = r.pim_proy>0   ? r.dev_proy/r.pim_proy   :0;
      const ava2  = r.pim_act>0    ? r.dev_act/r.pim_act     :0;

      const tr=document.createElement('tr');
      tr.className='item';
      tr.setAttribute('data-parent',gid);
      tr.style.display='none';
      tr.innerHTML=`
        <td style="padding-left:20px;text-align:left;white-space:normal;word-break:break-word;">
          ${r.ejecutora}
        </td>
        <td class="num">${fmt.format(r.pim)}</td>
        <td class="num">${fmt.format(r.dev)}</td>
        <td class="pct"><span class="dot ${chipClass(av2)}"></span>${pctStr(av2)}</td>
        <td class="num">${fmt.format(r.pim_proy)}</td>
        <td class="num">${fmt.format(r.dev_proy)}</td>
        <td class="pct"><span class="dot ${chipClass(avp2)}"></span>${pctStr(avp2)}</td>
        <td class="num">${fmt.format(r.pim_act)}</td>
        <td class="num">${fmt.format(r.dev_act)}</td>
        <td class="pct"><span class="dot ${chipClass(ava2)}"></span>${pctStr(ava2)}</td>`;
      tbody.appendChild(tr);
    }
  }

  /* Totales */
  const tfoot=document.getElementById('tfoot');
  const tav  = tot.pim>0        ? tot.dev/tot.pim               :0;
  const tavp = tot.pim_proy>0   ? tot.dev_proy/tot.pim_proy     :0;
  const tava = tot.pim_act>0    ? tot.dev_act/tot.pim_act       :0;

  tfoot.innerHTML=`
    <tr>
      <td style="text-align:left;font-weight:900;">Total</td>
      <td class="num">${fmt.format(tot.pim)}</td>
      <td class="num">${fmt.format(tot.dev)}</td>
      <td class="pct"><span class="dot ${chipClass(tav)}"></span>${pctStr(tav)}</td>
      <td class="num">${fmt.format(tot.pim_proy)}</td>
      <td class="num">${fmt.format(tot.dev_proy)}</td>
      <td class="pct"><span class="dot ${chipClass(tavp)}"></span>${pctStr(tavp)}</td>
      <td class="num">${fmt.format(tot.pim_act)}</td>
      <td class="num">${fmt.format(tot.dev_act)}</td>
      <td class="pct"><span class="dot ${chipClass(tava)}"></span>${pctStr(tava)}</td>
    </tr>`;

  /* expandir/colapsar ejecutoras */
  tbody.querySelectorAll('button[aria-controls]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=btn.getAttribute('aria-controls');
      const open=btn.getAttribute('aria-expanded')==='true';
      btn.setAttribute('aria-expanded',String(!open));
      tbody.querySelectorAll(`tr.item[data-parent="${id}"]`).forEach(tr=>{
        tr.style.display=open?'none':'';
      });
    });
  });
}

/* Export a Excel */
function exportTableToExcel(tableId='tbl', filename='ejecutoras_matriz.xls'){
  const table=document.getElementById(tableId); if(!table) return;
  const clone=table.cloneNode(true);
  clone.querySelectorAll('td.num, th.num').forEach(td=>{
    td.setAttribute('style',(td.getAttribute('style')||'')+'; mso-number-format:"\\#\\,\\#\\#0";');
  });
  const html=`<!DOCTYPE html><html><head><meta charset="utf-8">
  <style>table{border-collapse:collapse}th,td{border:1px solid #d1d5db;padding:6px 8px;white-space:nowrap}
  th{background:#111827;color:#fff;font-weight:800}tfoot td{background:#f8fafc;font-weight:800}</style>
  </head><body>${clone.outerHTML}</body></html>`;
  const blob=new Blob([html],{type:'application/vnd.ms-excel;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
document.getElementById('btnCsv').addEventListener('click',()=>exportTableToExcel('tbl'));

/* Init */
(async()=>{
  try{
    const [all,proy,act]=await Promise.all([
      queryStats("1=1"),
      queryStats("tipo_act_proy_nombre = 'PROYECTO'"),
      queryStats("tipo_act_proy_nombre = 'ACTIVIDAD'")
    ]);
    renderTable(mergeStats(all,proy,act));
  }catch(err){
    console.error(err);
    document.getElementById('tbody').innerHTML=
      `<tr><td colspan="10" style="text-align:center;color:#b91c1c;padding:30px;">
         Error al cargar datos: ${err?.message||'Fallo del servicio'}
       </td></tr>`;
  }
})();
</script>
</body>
</html>
