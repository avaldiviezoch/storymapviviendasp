<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PIM 2025 – Fullscreen</title>
<style>
  /* Full-bleed: nada de márgenes ni fondos extra */
  html, body {
    height: 100%;
    margin: 0;
    background: transparent; /* sin fondo, usa el del StoryMap */
    color: #062e2b;
    font-family: system-ui, Segoe UI, Roboto, Arial;
    overflow: hidden; /* evita cualquier scroll */
  }

  /* Ocupa todo el viewport y centra el contenido */
  .stage {
    height: 100vh;
    width: 100vw;
    display: grid;
    grid-template-rows: auto 1fr auto;
    align-items: center;
    justify-items: center;
    box-sizing: border-box;
    padding: 0 clamp(8px, 2vw, 24px);
  }

  /* Título arriba, centrado */
  .title {
    margin: 0;
    text-align: center;
    font-weight: 800;
    letter-spacing: .2px;
    color: #062e2b;
    font-size: clamp(18px, 3.2vw, 40px);
  }

  /* Zona central: símbolo y monto en una fila */
  .center {
    display: inline-flex;
    align-items: flex-end;
    gap: clamp(10px, 2vw, 20px);
    transform-origin: center bottom; /* para el auto-fit */
  }

  /* Prefijo (S/.) */
  .prefix {
    font-weight: 900;
    color: #043a36;
    line-height: 1;
    transform: translateY(-6%);
    font-size: clamp(26px, 7vw, 10.5vh);
    opacity: 0;
    transition: .35s ease;
  }

  /* Monto principal */
  .amount {
    font-weight: 900;
    color: #043a36;
    line-height: 1.05;
    font-size: clamp(40px, 16.5vw, 20vh);
    letter-spacing: .02em;
    white-space: nowrap;
    opacity: 0;
    transform: translateY(8px);
    transition: .35s ease;
  }
  .amount.ready { opacity: 1; transform: translateY(0); }
  .prefix.ready { opacity: 1; transform: translateY(0); }

  /* Fuente abajo */
  .source {
    margin: 0 0 clamp(6px, 1.5vh, 14px) 0;
    text-align: center;
    color: #334155;
    font-size: clamp(11px, 1.6vw, 13px);
  }
  .source b { color:#0369a1; }
</style>
</head>
<body>
  <div class="stage">
    <h2 class="title">Presupuesto Institucional Modificado 2025</h2>

    <div style="display:grid;place-items:center">
      <div class="center" id="row">
        <div class="prefix" id="cur">S/.</div>
        <div class="amount" id="val">0</div>
      </div>
    </div>

    <div class="source">
      <b>Fuente:</b> Ministerio de Economía y Finanzas — MEF · Portal de Datos Abiertos · 
      <em id="lastUpdate">Actualizado al —</em>
    </div>
  </div>

<script>
/* ==== ArcGIS REST (outStatistics para sumar y fecha más reciente) ==== */
const SERVICE = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
const WHERE   = "sector_nombre = 'VIVIENDA CONSTRUCCION Y SANEAMIENTO' AND ano_eje = 2025";

async function fetchPIMandMaxDate(){
  const outStats = JSON.stringify([
    { statisticType: "sum", onStatisticField: "monto_pim",     outStatisticFieldName: "sum_pim" },
    { statisticType: "max", onStatisticField: "fecha_proceso", outStatisticFieldName: "max_fp"  }
  ]);
  const qs = new URLSearchParams({
    where: WHERE,
    outStatistics: outStats,
    returnGeometry: "false",
    f: "json"
  });
  const url = SERVICE + "?" + qs.toString();
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error("HTTP " + res.status);
  const json = await res.json();
  if(json.error) throw new Error(json.error.message || "Error del servicio");
  const attrs = json.features?.[0]?.attributes || {};
  return {
    total: Number(attrs.sum_pim) || 0,
    lastTs: (attrs.max_fp != null) ? Number(attrs.max_fp) : null
  };
}

/* ==== Conteo animado ==== */
function animateNumber(el, target, ms=1700){
  const fmt = new Intl.NumberFormat('es-PE');
  const start = performance.now();
  function tick(t){
    const p = Math.min(1, (t - start) / ms);
    const eased = 1 - Math.pow(1 - p, 3); // easeOutCubic
    const cur = Math.round(target * eased);
    el.textContent = fmt.format(cur);
    if(p < 1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

/* Formato de fecha en español */
function formatEsDate(ts){
  if(!Number.isFinite(ts)) return "—";
  const d = new Date(ts);
  const fmt = new Intl.DateTimeFormat("es-PE", { day:"2-digit", month:"long", year:"numeric" });
  return fmt.format(d);
}

/* Auto-fit para pantallas estrechas */
function fitRow(){
  const row = document.getElementById('row');
  row.style.transform = 'scale(1)';
  const pad = Math.max(8, Math.min(window.innerWidth*0.02, 24));
  const available = window.innerWidth - pad*2;
  const needed = row.scrollWidth;
  if (needed > available) {
    const s = Math.max(0.85, available / needed);
    row.style.transform = `scale(${s})`;
  }
}

(async function init(){
  const val  = document.getElementById('val');
  const cur  = document.getElementById('cur');
  const last = document.getElementById('lastUpdate');
  try{
    const { total, lastTs } = await fetchPIMandMaxDate();
    requestAnimationFrame(()=>{
      val.classList.add('ready');
      cur.classList.add('ready');
      fitRow();
    });
    animateNumber(val, total);
    last.textContent = "Actualizado al " + formatEsDate(lastTs);
  }catch(e){
    console.error(e);
    val.textContent = "—";
    last.textContent = "Actualizado al —";
    val.classList.add('ready');
    cur.classList.add('ready');
    fitRow();
  }
})();

window.addEventListener('resize', fitRow);
</script>
</body>
</html>
