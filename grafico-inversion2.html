<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Devengado Acumulado vs Monto de Inversi√≥n ‚Äî con Zoom tipo ECharts</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<style>
  :root{ --ink:#0b2532; --muted:#64748b; --grid:#e5e7eb; }
  html,body{height:100%;margin:0;background:#fff;color:var(--ink);
    font-family:system-ui,Segoe UI,Roboto,Arial}
  /* Layout: t√≠tulo + gr√°fico */
  .stage{
    height:100vh;width:100vw;display:grid;grid-template-rows:auto 1fr;
    gap:6px;padding:clamp(8px,2vw,16px); box-sizing:border-box
  }
  h1{margin:0;text-align:center;font-weight:900;letter-spacing:.3px;
     font-size:clamp(20px,3vw,38px)}
  /* Contenedor DEL GR√ÅFICO con altura expl√≠cita */
  .wrap{position:relative;height:100%}
  #chart{height:100%;width:100%;border-radius:14px;border:1px solid #eef2f7}

  /* Leyenda ‚Äúchips‚Äù (no bloquea zoom) */
  .legendBar{position:absolute; left:50%; transform:translateX(-50%);
    top:56px; z-index:5; display:flex; gap:10px; flex-wrap:wrap; pointer-events:none;}
  .leg{pointer-events:auto; display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; background:#fff;
    font-size:12px; font-weight:700; cursor:pointer; box-shadow:0 2px 10px rgba(0,0,0,.05);}
  .leg[aria-pressed="false"]{opacity:.35; background:#f8fafc}
  .sw{width:12px;height:12px;border-radius:50%}
</style>
</head>
<body>
  <div class="stage">
    <h1>Devengado Acumulado vs Monto de Inversi√≥n</h1>
    <div class="wrap">
      <div id="chart" role="img" aria-label="Dispersi√≥n de proyectos por devengado, inversi√≥n y beneficiarios"></div>
      <div class="legendBar" id="legendBar" aria-label="Filtrar por nivel de avance"></div>
    </div>
  </div>

<script>
/* -------- Endpoints -------- */
const LYR13 = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
const LYR1  = "https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/story_monitoreo_inversiones/FeatureServer/1/query";

/* -------- Filtros -------- */
const WHERE_13 = "monto_pim > 0 AND producto_proyecto IS NOT NULL AND producto_proyecto <> 2193247";
const WHERE_1  = "etapa IN ('OBRA','OBRA (SALDO)') AND montoactualizadopip_decimal > 0 AND devengadoacumulado >= 0";

/* -------- Categor√≠as por % -------- */
const CATS = [
  {key:"Bajo (0%‚Äì30%)",   short:"Bajo",  color:"#dc2626", match:p=> p<=30},
  {key:"Medio (30%‚Äì70%)", short:"Medio", color:"#f59e0b", match:p=> p>30 && p<70},
  {key:"Alto (70%‚Äì100%)", short:"Alto",  color:"#22c55e", match:p=> p>=70}
];

/* -------- Utils -------- */
function pct(dev, inv){ const d=+dev||0, m=+inv||0; return m>0 ? (d/m)*100 : 0; }
function catFromPct(p){ for(const c of CATS) if(c.match(p)) return c.short; return "Bajo"; }
function fmtCompact(n){
  const v=Number(n)||0, a=Math.abs(v);
  if(a>=1e9) return (v/1e9).toFixed(1).replace(/\.0$/,'')+" B";
  if(a>=1e6) return (v/1e6).toFixed(1).replace(/\.0$/,'')+" M";
  if(a>=1e3) return (v/1e3).toFixed(1).replace(/\.0$/,'')+" k";
  return v.toLocaleString('es-PE');
}
function fmtPct(p){ return (Math.round(p*10)/10).toLocaleString('es-PE')+"%"; }

/* ArcGIS helpers (POST + paginado) */
async function fetchAllPOST(url, baseParams){
  const pageSize=2000; let offset=0, out=[];
  while(true){
    const body = new URLSearchParams({
      ...baseParams, returnGeometry:"false", f:"json",
      resultRecordCount: pageSize, resultOffset: offset
    }).toString();
    const res = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
      body, cache:"no-store"
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const j = await res.json();
    if(j.error) throw new Error("ArcGIS: "+(j.error.message||"consulta inv√°lida"));
    const feats = j.features ?? [];
    out.push(...feats.map(f=>f.attributes||{}));
    if(!j.exceededTransferLimit && feats.length<pageSize) break;
    offset += pageSize;
  }
  return out;
}

/* -------- Carga de datos -------- */
async function loadData(){
  // 1) IDs v√°lidos desde CAPA 13
  const rows13 = await fetchAllPOST(LYR13, { where: WHERE_13, outFields: "producto_proyecto" });
  const idSet = new Set(rows13.map(r=>r.producto_proyecto).filter(v=>v!=null));
  if(idSet.size===0) return { Bajo:[], Medio:[], Alto:[], allX:[], allY:[], allSize:[] };

  // 2) CAPA 1 con IN (‚Ä¶) en chunks
  const ids = Array.from(idSet);
  const chunkSize = 900;
  let rows1 = [];
  for(let i=0;i<ids.length;i+=chunkSize){
    const slice = ids.slice(i,i+chunkSize);
    const where = `${WHERE_1} AND icodunificado IN (${slice.join(",")})`;
    const part = await fetchAllPOST(LYR1, {
      where,
      outFields: "icodunificado,devengadoacumulado,montoactualizadopip_decimal,nombreproyecto,beneficiarios"
    });
    rows1.push(...part);
  }

  // 3) Transformaci√≥n
  const byCat = { Bajo:[], Medio:[], Alto:[] };
  const allX=[], allY=[], allSize=[];
  for(const r of rows1){
    const x = +r.devengadoacumulado || 0;               // X: Devengado
    const y = +r.montoactualizadopip_decimal || 0;      // Y: Inversi√≥n
    const bens = +r.beneficiarios || 0;
    if(y<=0) continue;
    const p = pct(x,y);
    const c = catFromPct(p);
    byCat[c].push({ value:[x,y,bens,p,(r.icodunificado??""),(r.nombreproyecto??"").toString().trim()] });
    allX.push(x); allY.push(y); allSize.push(bens);
  }
  return { Bajo:byCat.Bajo, Medio:byCat.Medio, Alto:byCat.Alto, allX, allY, allSize };
}

/* ====== Render con ECharts ====== */
(async function run(){
  const el = document.getElementById('chart');
  const chart = echarts.init(el, null, { renderer: 'canvas' });

  try{
    chart.showLoading({ text: 'Cargando datos‚Ä¶' });
    const { Bajo, Medio, Alto, allX, allY, allSize } = await loadData();

    // Si no hay datos, mostramos mensaje
    if (!allX.length){
      chart.hideLoading();
      chart.setOption({
        title:{ text:'Sin datos para mostrar', left:'center', top:'middle' }
      });
      return;
    }

    // Tama√±o por beneficiarios (6‚Äì60 px)
    function extent(arr){let m=+Infinity,M=-Infinity;for(const v of arr)if(Number.isFinite(v)){if(v<m)m=v;if(v>M)M=v}if(!Number.isFinite(m)||!Number.isFinite(M))return[0,1];if(m===M)return[0,M||1];return[m,M]}
    const [minS,maxS]=extent(allSize);
    const sizeFn = (v)=>{
      const t = (maxS>minS) ? (Math.max(0,Number(v)||0)-minS)/(maxS-minS) : 0.5;
      return 6 + Math.sqrt(Math.max(0,Math.min(1,t))) * (60-6);
    };

    // Rango inicial (percentiles)
    function quantile(a,q){const s=a.slice().sort((x,y)=>x-y);if(!s.length)return NaN;const p=(s.length-1)*q,lo=Math.floor(p),hi=Math.ceil(p);return lo===hi?s[lo]:s[hi]+(s[hi]-s[lo])*(p-lo)}
    const xQ05=quantile(allX,0.05), xQ95=quantile(allX,0.95);
    const yQ05=quantile(allY,0.05), yQ95=quantile(allY,0.95);
    const xPad=(xQ95-xQ05)*0.05, yPad=(yQ95-yQ05)*0.05;
    const [xMinAll,xMaxAll]=extent(allX), [yMinAll,yMaxAll]=extent(allY);
    const xInitMin = Math.min(xQ05 - xPad, xMinAll);
    const xInitMax = Math.max(xQ95 + xPad, xMaxAll);
    const yInitMin = Math.min(yQ05 - yPad, yMinAll);
    const yInitMax = Math.max(yQ95 + yPad, yMaxAll);

    const series = [
      {name:'Bajo',  color:'#dc2626', data:Bajo},
      {name:'Medio', color:'#f59e0b', data:Medio},
      {name:'Alto',  color:'#22c55e', data:Alto}
    ].map(s=>({
      name:s.name, type:'scatter', data:s.data,
      itemStyle:{ color:s.color, opacity:0.9 },
      emphasis:{ itemStyle:{ borderColor:'#0f172a', borderWidth:1 }, scale:1.08 },
      symbolSize: params => sizeFn(params.value[2])
    }));

    const option = {
      title: { text: 'Devengado vs Inversi√≥n (burbuja = beneficiarios)', left:'center', top:8, textStyle:{ fontWeight:700, fontSize:16 } },
      legend: { top: 40, left: 'center', icon:'circle' },
      grid: { top: 86, left: 60, right: 24, bottom: 64, containLabel: true },
      tooltip: {
        trigger: 'item',
        borderWidth: 1,
        padding: 8,
        confine: true,           // üîí evita que se salga del canvas
        appendToBody: true,      // üìé mejor posicionamiento en overflow
        extraCssText: 'max-width:320px;white-space:normal;box-shadow:0 10px 24px rgba(2,6,23,.12),0 2px 6px rgba(2,6,23,.08);',
        formatter: (obj) => {
          const [dev, inv, bens, p, cui, nombre] = obj.value;
          return `
            <div style="font-weight:700;margin-bottom:4px">${obj.seriesName}</div>
            <div><span style="color:#64748b">Devengado:</span> <b>${fmtCompact(dev)}</b></div>
            <div><span style="color:#64748b">Monto inversi√≥n:</span> <b>${fmtCompact(inv)}</b></div>
            <div><span style="color:#64748b">Beneficiarios:</span> <b>${(bens||0).toLocaleString('es-PE')}</b></div>
            <div><span style="color:#64748b">% Avance:</span> <b>${fmtPct(p)}</b></div>
            ${cui ? `<div><span style="color:#64748b">CUI:</span> <b>${cui}</b></div>` : ''}
            ${nombre ? `<div style="margin-top:6px"><b>${nombre}</b></div>` : ''}
          `;
        }
      },
      xAxis: {
        type: 'value',
        name: 'Devengado Acumulado',
        nameLocation: 'middle',
        nameGap: 28,
        min: xInitMin, max: xInitMax,
        splitLine: { show: true },
        axisLabel: { formatter: v => fmtCompact(v) },
        scale: true
      },
      yAxis: {
        type: 'value',
        name: 'Monto de Inversi√≥n',
        nameLocation: 'middle',
        nameGap: 42,
        min: yInitMin, max: yInitMax,
        splitLine: { show: true },
        axisLabel: { formatter: v => fmtCompact(v) },
        scale: true
      },
      /* Zoom como tu ejemplo 2 */
      dataZoom: [
        { type:'slider', xAxisIndex:0, filterMode:'none', bottom:12, height:28 },
        { type:'inside', xAxisIndex:0, filterMode:'none' },
        { type:'slider', yAxisIndex:0, filterMode:'none', right:6, width:12 },
        { type:'inside', yAxisIndex:0, filterMode:'none' }
      ],
      series
    };

    chart.hideLoading();
    chart.setOption(option);
    window.addEventListener('resize', ()=>chart.resize());

    /* Leyenda externa opcional (toggle por serie) */
    const legendBar = document.getElementById('legendBar');
    if (legendBar) {
      legendBar.innerHTML = '';
      ['Bajo','Medio','Alto'].forEach((name) => {
        const color = name==='Bajo' ? '#dc2626' : name==='Medio' ? '#f59e0b' : '#22c55e';
        const key   = name==='Bajo' ? 'Bajo (0%‚Äì30%)' : name==='Medio' ? 'Medio (30%‚Äì70%)' : 'Alto (70%‚Äì100%)';
        const b = document.createElement('button');
        b.className = 'leg'; b.type='button'; b.setAttribute('aria-pressed','true');
        b.innerHTML = `<span class="sw" style="background:${color}"></span>${key}`;
        b.onclick = () => {
          const pressed = b.getAttribute('aria-pressed') === 'true';
          b.setAttribute('aria-pressed', String(!pressed));
          chart.dispatchAction({ type: 'legendToggleSelect', name });
        };
        legendBar.appendChild(b);
      });
    }
  }catch(err){
    console.error(err);
    chart.hideLoading();
    chart.setOption({
      title:{ text:'Error al cargar datos', left:'center', top:'middle' },
      graphic:{ type:'text', left:'center', top:'middle',
        style:{ text: (err&&err.message)? err.message : 'Fallo de carga.', fontSize:14 } }
    });
  }
})();
</script>
</body>
</html>
