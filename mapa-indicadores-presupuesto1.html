<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Visor · Vivienda Rural + CCPP + Límites (UI verde flotante)</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.30/"></script>

<style>
  :root{
    --ink:#0b2532; --muted:#64748b; --card:#fff;
    --g-dark:#0f3f3a; --g-2:#7da39e; --line:#e6ecea; --panel:#f7fbfa;
    --bar:#0b3b38;
  }
  html,body{margin:0; height:100%; overflow:hidden; background:#eef5f3; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .shell{display:grid; grid-template-columns: 1fr min(44vw, 720px); height:100vh; width:100vw;}
  #viewWrap{ position:sticky; top:0; height:100vh; overflow:hidden; }
  #viewDiv{position:relative; width:100%; height:100%}

  /* Panel derecho (vacío) */
  .sidebar{background:var(--panel); border-left:1px solid var(--line); box-shadow:-6px 0 24px rgba(2,6,23,.06); padding:16px 16px 18px; box-sizing:border-box;}
  .topTitle{text-align:center; font-weight:900; letter-spacing:.2px; font-size:clamp(18px, 2.2vh, 22px); margin:2px 0 6px;}
  .bar{background:var(--bar); color:#e7fff9; font-weight:800; text-align:center; padding:10px 12px; border-radius:10px; margin:6px 0 12px; font-size:clamp(12px, 1.6vh, 14px);}

  /* Flotantes retráctiles (estética verde) */
  .floatPanels{position:absolute; left:14px; top:14px; z-index:6; width:min(360px, 92vw); display:grid; gap:10px;}
  .acc{background:#0b3b38; color:#e6fffb; border-radius:14px; box-shadow:0 12px 28px rgba(0,0,0,.18); overflow:hidden}
  .acc summary{list-style:none; cursor:pointer; padding:12px 14px; display:flex; justify-content:space-between; align-items:center; font-weight:900; letter-spacing:.2px}
  .acc summary::-webkit-details-marker{display:none}
  .acc .content{padding:10px 12px; background:#0f2e29; border-top:1px solid #0e4a43}
  .hint{font-size:12px; color:#b9d5d1; padding:6px 12px 10px}

  /* Widgets dentro del panel verde */
  .acc .content .esri-legend, 
  .acc .content .esri-layer-list{
    --esri-widget-padding: 6px;
    --esri-widget-border-color: #0e4a43;
    --esri-widget-shadow: 0 6px 18px rgba(2,6,23,.12);
    font-size: 12.5px;
    border:1px solid #0e4a43;
    border-radius:10px;
    background:#0f2e29;
    color:#dff7f3;
  }
  .esri-layer-list__item-label,
  .esri-legend__service-label{ color:#e6fffb !important; }

  /* Popup */
  .pop-card{background:#ffffff; border:1px solid var(--line); border-radius:14px; box-shadow:0 12px 30px rgba(2,6,23,.12); overflow:hidden; min-width:min(320px, 78vw); max-width:min(520px, 86vw); color:#0b2532; font:12.5px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
  .pop-hdr{background:#0b3b38; color:#e6fffb; padding:10px 12px; font-weight:900; letter-spacing:.2px;}
  .pop-grid{display:grid; grid-template-columns:1fr 1fr; gap:8px 12px; padding:12px;}
  .pop-grid .lbl{font-weight:800; color:#47606b; font-size:11.5px}
  .pop-grid .val{font-weight:800; color:#0b2532}
  .esri-popup__header{display:none !important;}
  .esri-popup__main-container{padding-top:0 !important;}

  @media (max-width: 1100px){ .shell{grid-template-columns: 1fr min(50vw, 720px);} }
  @media (max-width: 900px){
    .shell{grid-template-columns:1fr;}
    #viewWrap{position:relative; height:54vh;}
  }
</style>
</head>
<body>
<div class="shell">

  <!-- Mapa -->
  <div id="viewWrap">
    <div id="viewDiv" aria-label="Mapa Vivienda Rural + CCPP + Límites"></div>

    <!-- Flotantes retráctiles (cerrados por defecto) -->
    <div class="floatPanels">
      <details class="acc">
        <summary>Capas <span>▾</span></summary>
        <div class="content"><div id="layerListNode"></div></div>
        <div class="hint">Activa/desactiva capas. Algunas aparecen según el nivel de zoom.</div>
      </details>

      <details class="acc">
        <summary>Leyenda <span>▾</span></summary>
        <div class="content"><div id="legendNode"></div></div>
      </details>
    </div>
  </div>

  <!-- Panel derecho vacío -->
  <aside class="sidebar">
    <div class="topTitle">Mapa · Vivienda Rural, CCPP y Límites</div>
    <div class="bar">Cartografía OGEI · MVCS</div>
    <!-- vacío -->
  </aside>
</div>

<script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer",
  "esri/widgets/Legend",
  "esri/widgets/LayerList",
  "esri/widgets/ScaleBar",
  "esri/renderers/UniqueValueRenderer",
  "esri/symbols/SimpleFillSymbol",
  "esri/symbols/SimpleLineSymbol",
  "esri/symbols/SimpleMarkerSymbol"
], (Map, MapView, FeatureLayer, Legend, LayerList, ScaleBar, UniqueValueRenderer,
    SimpleFillSymbol, SimpleLineSymbol, SimpleMarkerSymbol) => {

  // ENDPOINTS
  const CCPP = "https://pportalgis.vivienda.gob.pe/pfdserver1/rest/services/OGEI/CCPP_Dispersos/FeatureServer";
  const VR   = "https://dportalgis.vivienda.gob.pe/dfdserver/rest/services/OGEI/vivienda_rural/FeatureServer/0";
  const LIM0 = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/COES/Limites_Pol%C3%ADticos/MapServer/0";
  const LIM1 = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/COES/Limites_Pol%C3%ADticos/MapServer/1";
  const LIM2 = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/COES/Limites_Pol%C3%ADticos/MapServer/2";

  // Mapa base
  const map = new Map({ basemap: "gray-vector" });
  const view = new MapView({
    container: "viewDiv",
    map,
    // Vista inicial: costa del Lago Titicaca (Puno)
    center: [-69.35, -15.9],
    scale: 180000, // ~1:180k (VR visible por minScale=300k)
    constraints: { minZoom: 4, snapToZoom: false },
    highlightOptions: { color: [13,58,53,1], haloOpacity: 0.15, fillOpacity: 0.05 }
  });
  view.ui.add(new ScaleBar({ view, unit: "metric" }), "bottom-left");

  // Popup compacto
  view.popup.title = "";
  try { view.popup.visibleElements = { title: false }; } catch(_){}

  // Capas CCPP
  const ccppLayers = [
    new FeatureLayer({ url: `${CCPP}/6`, title: "Áreas agrupadas (densidad y viviendas)", outFields:["*"], visible:false }),
    new FeatureLayer({ url: `${CCPP}/5`, title: "Ámbito territorial de centros poblados", outFields:["*"], visible:false }),
    new FeatureLayer({ url: `${CCPP}/4`, title: "Centro poblado por grado de dispersión",  outFields:["*"], visible:true  }),
    new FeatureLayer({ url: `${CCPP}/3`, title: "Redes - DATASS",                          outFields:["*"], visible:false }),
    new FeatureLayer({ url: `${CCPP}/2`, title: "Reservorio - DATASS",                      outFields:["*"], visible:false }),
    new FeatureLayer({ url: `${CCPP}/1`, title: "Captación - DATASS",                       outFields:["*"], visible:false }),
    new FeatureLayer({ url: `${CCPP}/0`, title: "PTAP - DATASS",                            outFields:["*"], visible:false })
  ];

  // Vivienda Rural (3 categorías exactas, visible a ciudad)
  const FIELD = "dhabcual";
  const defExp = `${FIELD} IN ('Con Deficit Cualitativo','''Sin Dcficit Cualitativo','Otro')`;

  const COL_DEFICIT = [198, 42, 75, 0.90];   // rojo
  const COL_SIN     = [ 60,130,246,0.90];    // azul
  const COL_OTRO    = [168,170,175,0.70];    // plomo

  const mkSymbol = (rgba) => new SimpleMarkerSymbol({ style:"circle", size:7, color:rgba, outline:{ color:[255,255,255,1], width:0.6 }});
  const lnSymbol = (rgba) => new SimpleLineSymbol({ color:rgba, width:2 });
  const flSymbol = (rgba) => new SimpleFillSymbol({ color:rgba, outline:{ color:[255,255,255,1], width:0.5 }});
  const symbolForGeom = (geom, rgba) => geom === "polygon" ? flSymbol(rgba) : (geom === "polyline" ? lnSymbol(rgba) : mkSymbol(rgba));

  function vrRenderer(geom){
    return new UniqueValueRenderer({
      field: FIELD,
      defaultSymbol: null,
      uniqueValueInfos: [
        { value:"Con Deficit Cualitativo",  label:"Con Déficit Cualitativo", symbol:symbolForGeom(geom, COL_DEFICIT) },
        { value:"'Sin Dcficit Cualitativo", label:"Sin Déficit Cualitativo", symbol:symbolForGeom(geom, COL_SIN) },
        { value:"Otro",                      label:"Otro",                    symbol:symbolForGeom(geom, COL_OTRO) }
      ]
    });
  }

  const viviendaRural = new FeatureLayer({
    url: VR,
    title: "Vivienda rural - Viviendas Rurales",
    outFields: ["*"],
    definitionExpression: defExp,
    minScale: 300000, // visible desde ciudad
    maxScale: 0,
    visible: true,
    popupTemplate: {
      title: "",
      outFields:["*"],
      content: (e)=>{
        const a = e.graphic.attributes||{};
        const safe = (v)=> (v==null||v==="") ? "—" : String(v);
        return `
          <div class="pop-card">
            <div class="pop-hdr">${safe(a.NOMBRE)||"Vivienda rural"}</div>
            <div class="pop-grid">
              <div class="lbl">Déficit Habitacional Cualitativo</div><div class="val">${safe(a[FIELD])}</div>
              <div class="lbl">Departamento</div><div class="val">${safe(a.departamen||a.departamento)}</div>
              <div class="lbl">Provincia</div><div class="val">${safe(a.provincia)}</div>
              <div class="lbl">Distrito</div><div class="val">${safe(a.distrito)}</div>
            </div>
          </div>
        `;
      }
    }
  });
  viviendaRural.when(()=>{ viviendaRural.renderer = vrRenderer(viviendaRural.geometryType); });

  // Límites políticos
  function outlineRenderer(color, width){
    return { type:"simple", symbol: new SimpleFillSymbol({ color:[0,0,0,0], outline:new SimpleLineSymbol({ color, width }) }) };
  }
  function lineRenderer(color, width){
    return { type:"simple", symbol: new SimpleLineSymbol({ color, width }) };
  }
  async function boundaryLayer(url, title, color, width, minScale){
    const lyr = new FeatureLayer({ url, title, visible:true, minScale, maxScale:0 });
    try{
      await lyr.load();
      lyr.renderer = (lyr.geometryType === "polygon") ? outlineRenderer(color, width) : lineRenderer(color, width);
    }catch{
      lyr.renderer = lineRenderer(color, width);
    }
    return lyr;
  }

  Promise.all([
    boundaryLayer(LIM0, "Límite Departamental", [0,0,0,0.85], 2.0, 0),
    boundaryLayer(LIM1, "Límite Provincial",    [0,0,0,0.70], 1.5, 2000000),
    boundaryLayer(LIM2, "Límite Distrital",     [0,0,0,0.55], 1.0, 600000)
  ]).then((limites) => {
    const layers = [ ...limites, viviendaRural, ...ccppLayers ];
    map.addMany(layers);

    // Widgets en paneles flotantes (cerrados por defecto)
    new Legend({ view, container: "legendNode" });
    new LayerList({
      view,
      container: "layerListNode",
      selectionEnabled: true,
      listItemCreatedFunction: (e)=>{ e.item.panel = { content: "legend", open: false }; }
    });
  });

});
</script>
</body>
</html>
