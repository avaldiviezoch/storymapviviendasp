<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Devengado 2025 – Fullscreen</title>
<style>
  html, body {
    height: 100%;
    margin: 0;
    background: transparent;
    color: #062e2b;
    font-family: system-ui, Segoe UI, Roboto, Arial;
    overflow: hidden;
  }

  .stage {
    height: 100vh;
    width: 100vw;
    display: grid;
    grid-template-rows: auto 1fr auto;
    align-items: center;
    justify-items: center;
    box-sizing: border-box;
    padding: 0 clamp(8px, 2vw, 24px);
  }

  .title {
    margin: 0;
    text-align: center;
    font-weight: 800;
    letter-spacing: .2px;
    color: #062e2b;
    font-size: clamp(18px, 3.2vw, 40px);
  }

  .center {
    display: grid;
    place-items: center;
    transform-origin: center bottom;
  }

  .prefix {
    font-weight: 900;
    color: #043a36;
    line-height: 1;
    font-size: clamp(26px, 7vw, 10.5vh);
    opacity: 0;
    transition: .35s ease;
  }

  .amount {
    font-weight: 900;
    color: #043a36;
    line-height: 1.05;
    font-size: clamp(40px, 16.5vw, 20vh);
    letter-spacing: .02em;
    white-space: nowrap;
    opacity: 0;
    transition: .35s ease;
  }
  .amount.ready { opacity: 1; }
  .prefix.ready { opacity: 1; }

  .percent {
    margin-top: clamp(6px, 1.8vh, 14px);
    text-align: center;
    font-weight: 800;
    color: #0b3b38;
    font-size: clamp(18px, 3vw, 28px);
    opacity: 0;
    transition: .35s ease;
  }
  .percent.ready { opacity: 1; }

  .source {
    margin: 0 0 clamp(6px, 1.5vh, 14px) 0;
    text-align: center;
    color: #334155;
    font-size: clamp(11px, 1.6vw, 13px);
  }
  .source b { color:#0369a1; }
</style>
</head>
<body>
  <div class="stage">
    <h2 class="title">Presupuesto Devengado 2025</h2>

    <div class="center">
      <div>
        <span class="prefix" id="cur">S/.</span>
        <span class="amount" id="val">0</span>
      </div>
      <div class="percent" id="percent">0%</div>
    </div>

    <div class="source">
      <b>Fuente:</b> Ministerio de Economía y Finanzas — MEF · Portal de Datos Abiertos ·
      <em id="lastUpdate">Actualizado al —</em>
    </div>
  </div>

<script>
const SERVICE = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/FeatureServer/13/query";
const WHERE   = "sector_nombre = 'VIVIENDA CONSTRUCCION Y SANEAMIENTO' AND ano_eje = 2025";

/* Trae sum(devengado), sum(pim) y max(fecha_proceso) en UNA consulta */
async function fetchDevengadoData(){
  const outStats = JSON.stringify([
    { statisticType: "sum", onStatisticField: "monto_devengado", outStatisticFieldName: "sum_dev" },
    { statisticType: "sum", onStatisticField: "monto_pim",       outStatisticFieldName: "sum_pim" },
    { statisticType: "max", onStatisticField: "fecha_proceso",   outStatisticFieldName: "max_fp"  }
  ]);
  const qs = new URLSearchParams({
    where: WHERE,
    outStatistics: outStats,
    returnGeometry: "false",
    f: "json"
  });
  const url = SERVICE + "?" + qs.toString();
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error("HTTP " + res.status);
  const json = await res.json();
  if(json.error) throw new Error(json.error.message || "Error del servicio");
  const a = json.features?.[0]?.attributes || {};
  return {
    dev: Number(a.sum_dev||0),
    pim: Number(a.sum_pim||0),
    lastTs: (a.max_fp != null) ? Number(a.max_fp) : null
  };
}

/* Animaciones */
function animateNumber(el, target, ms=1700, fmt, suffix=""){
  const start = performance.now();
  function tick(t){
    const p = Math.min(1, (t - start) / ms);
    const eased = 1 - Math.pow(1 - p, 3);
    const cur = target * eased;
    el.textContent = fmt.format(cur) + suffix;
    if(p < 1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

/* Fecha estilo es-PE: 14 de septiembre de 2025 */
function formatEsDate(ts){
  if(!Number.isFinite(ts)) return "—";
  const d = new Date(ts);
  const fmt = new Intl.DateTimeFormat("es-PE", { day:"2-digit", month:"long", year:"numeric" });
  return fmt.format(d);
}

(async function init(){
  const val = document.getElementById('val');
  const cur = document.getElementById('cur');
  const percentEl = document.getElementById('percent');
  const last = document.getElementById('lastUpdate');

  try{
    const { dev, pim, lastTs } = await fetchDevengadoData();
    const perc = pim > 0 ? (dev / pim * 100) : 0;

    requestAnimationFrame(()=>{
      val.classList.add('ready');
      cur.classList.add('ready');
      percentEl.classList.add('ready');
    });

    // formateadores
    const fmtInt  = new Intl.NumberFormat('es-PE', { maximumFractionDigits: 0 });
    const fmtPerc = new Intl.NumberFormat('es-PE', { minimumFractionDigits: 1, maximumFractionDigits: 1 });

    animateNumber(val, dev, 1700, fmtInt);              // monto sin decimales
    animateNumber(percentEl, perc, 1700, fmtPerc, "%"); // porcentaje con 1 decimal

    last.textContent = "Actualizado al " + formatEsDate(lastTs);
  }catch(e){
    console.error(e);
    val.textContent = "—";
    percentEl.textContent = "—";
    document.getElementById('lastUpdate').textContent = "Actualizado al —";
    val.classList.add('ready');
    cur.classList.add('ready');
    percentEl.classList.add('ready');
  }
})();
</script>
</body>
</html>
