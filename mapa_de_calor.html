<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Grado de dispersi√≥n de centros poblados - PNSR</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Esri Leaflet -->
<script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js"></script>

<!-- Leaflet.heat -->
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<!-- Turf.js -->
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<style>
  :root{
    --ink:#0b2532; --sep:#e6ecea; --panel:#ffffff;
    --brand:#0b3b38; --muted:#47606b;
  }
  html,body{height:100%;margin:0}
  body{display:grid; grid-template-rows:auto 1fr; background:#eef5f3; color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .shell{display:grid; grid-template-columns:65% 35%; min-height:0}
  #viewWrap{position:relative; min-height:0}
  #map{height:100%; width:100%}

  /* Header t√≠tulo */
  .mainTitleBar{
    width:100%; background:#fff; border-bottom:1px solid var(--sep);
    box-shadow:0 2px 6px rgba(0,0,0,.08); padding:10px 12px; position:sticky; top:0; z-index:30;
  }
  .mainTitle{margin:0; text-align:center; font-weight:1000; font-size:clamp(18px,3.5vh,22px); color:var(--brand)}

  /* Panel derecho (igual ‚Äúsensaci√≥n‚Äù 35%) */
  aside{
    background:var(--panel); border-left:1px solid var(--sep);
    box-shadow:-6px 0 24px rgba(2,6,23,.06); padding:12px; display:grid; grid-template-rows:auto 1fr; gap:12px; min-height:0;
  }

  /* Filtros en una sola l√≠nea */
  .filters{
    background:#fff; border:1px solid var(--sep); border-radius:14px; padding:10px; display:grid; gap:8px;
  }
  .filtersGrid{display:grid; gap:8px; align-items:end; grid-template-columns:1fr 1fr 1fr 1fr; }
  .fld{display:grid; gap:4px; min-width:0}
  .fld label{font-size:12px; color:var(--muted); font-weight:900; letter-spacing:.2px}
  select{
    padding:9px 10px; border:1px solid #cfe7e3; border-radius:10px; background:#e8f5f3;
    color:#0b3b38; font-weight:800; font-size:13.2px; outline:none; width:100%;
    -webkit-appearance:none; appearance:none;
  }
  .rowBtns{display:flex; gap:8px; justify-content:flex-end}
  .btn{background:#0b3b38; color:#ecfffb; border:1px solid #0e4a43; padding:9px 14px; border-radius:10px; font-weight:900; cursor:pointer}

  /* Burbujas flotantes (capas/leyenda) */
  .fab-wrap{position:absolute; right:14px; top:14px; display:flex; flex-direction:column; gap:10px; z-index:7}
  .fab{width:44px; height:44px; border-radius:50%; display:grid; place-items:center; background:#0b3b38; color:#e6fffb; border:1px solid #0e4a43; cursor:pointer; box-shadow:0 10px 22px rgba(0,0,0,.22); font-weight:900; user-select:none}
  .fab:hover{filter:brightness(1.06)}
  .bubble{position:absolute; right:70px; top:14px; min-width:300px; max-width:min(420px,88vw); background:#fff; color:var(--ink); border:1px solid var(--sep); border-radius:16px; box-shadow:0 14px 32px rgba(0,0,0,.18); z-index:8; display:none}
  .bubble header{padding:10px 12px; background:#fff; border-bottom:1px solid var(--sep); border-radius:16px 16px 0 0; display:flex; align-items:center; justify-content:space-between; cursor:move; gap:8px}
  .bubble .ttl{font-weight:900; letter-spacing:.2px}
  .bubble .x{cursor:pointer; border:1px solid var(--sep); background:#fff; color:var(--ink); border-radius:10px; padding:6px 10px; font-weight:800}
  .bubble .content{padding:10px 10px 12px}
  .scroll{max-height:65vh; overflow:auto; border-radius:10px; border:1px solid var(--sep); padding:10px}

  /* Leyenda simple */
  .legendItem{display:flex; align-items:center; gap:10px; margin-bottom:8px}
  .legBox{width:24px; height:10px; border-radius:6px}
  .legLine{width:26px; height:0; border-top:4px solid; border-radius:4px}

  /* Panes para glow ‚Äúsolo borde‚Äù, sin relleno */
  .leaflet-pane.glow-outer{ mix-blend-mode: screen; z-index:650 }
  .leaflet-pane.glow-mid  { mix-blend-mode: screen; z-index:651 }
  .leaflet-pane.glow-inner{ mix-blend-mode: screen; z-index:652 }

  @media (max-width: 1000px){
    .shell{grid-template-columns:1fr}
    #viewWrap{height:58vh}
  }
</style>
</head>
<body>

<header class="mainTitleBar">
  <h1 class="mainTitle">Grado de dispersi√≥n de centros poblados - PNSR</h1>
</header>

<div class="shell">
  <div id="viewWrap">
    <div id="map"></div>

    <!-- FABs -->
    <div class="fab-wrap">
      <div id="btnLayers" class="fab" title="Capas">üóÇÔ∏è</div>
      <div id="btnLegend" class="fab" title="Leyenda">üè∑Ô∏è</div>
    </div>

    <!-- Burbujas -->
    <div id="bubbleLayers" class="bubble" style="top:14px;">
      <header data-drag="#bubbleLayers"><span class="ttl">Capas</span><button class="x" data-close="#bubbleLayers">Cerrar</button></header>
      <div class="content">
        <div class="scroll">
          <div>
            <label><input type="checkbox" id="chkHeat" checked/> Heatmap (concentraci√≥n)</label><br/>
            <label><input type="checkbox" id="chkLabels" checked/> R√≥tulos del sat√©lite</label><br/>
            <label><input type="checkbox" id="chkGlow" checked/> Brillo de l√≠mite (zoom)</label>
          </div>
        </div>
      </div>
    </div>

    <div id="bubbleLegend" class="bubble" style="top:190px;">
      <header data-drag="#bubbleLegend"><span class="ttl">Leyenda</span><button class="x" data-close="#bubbleLegend">Cerrar</button></header>
      <div class="content">
        <div class="scroll">
          <div class="legendItem"><div class="legLine" style="border-color:#00ffff"></div> L√≠mite Departamental (glow)</div>
          <div class="legendItem"><div class="legLine" style="border-color:#ffd700"></div> L√≠mite Provincial (glow)</div>
          <div class="legendItem"><div class="legLine" style="border-color:#ff69b4"></div> L√≠mite Distrital (glow)</div>
          <div style="margin-top:10px; font-weight:900">Heatmap (gradiente)</div>
          <div class="legendItem"><div class="legBox" style="background:rgba(255,0,128,0)"></div> 0</div>
          <div class="legendItem"><div class="legBox" style="background:#ffd6eb"></div> Bajo</div>
          <div class="legendItem"><div class="legBox" style="background:#ff99cc"></div> Medio</div>
          <div class="legendItem"><div class="legBox" style="background:#ff4da6"></div> Alto</div>
          <div class="legendItem"><div class="legBox" style="background:#e60073"></div> Muy alto</div>
        </div>
      </div>
    </div>
  </div>

  <aside>
    <section class="filters" aria-label="Filtros (en l√≠nea)">
      <div class="filtersGrid">
        <div class="fld">
          <label for="selDep">Departamento</label>
          <select id="selDep"><option value="">(Todos)</option></select>
        </div>
        <div class="fld">
          <label for="selProv">Provincia</label>
          <select id="selProv" disabled><option value="">(Todas)</option></select>
        </div>
        <div class="fld">
          <label for="selDist">Distrito</label>
          <select id="selDist" disabled><option value="">(Todos)</option></select>
        </div>
        <div class="fld">
          <label for="selCP">Centro poblado</label>
          <select id="selCP" disabled><option value="">(Todos)</option></select>
        </div>
      </div>
      <div class="rowBtns">
        <button id="btnZoom" class="btn" type="button">Zoom/Glow</button>
        <button id="btnClear" class="btn" type="button">Limpiar filtros</button>
      </div>
    </section>
  </aside>
</div>

<script>
(function(){
  /* ====== ENDPOINTS ====== */
  const CCPP_BASE = "https://pportalgis.vivienda.gob.pe/pfdserver1/rest/services/OGEI/CCPP_Dispersos/FeatureServer";
  const SERVICE   = `${CCPP_BASE}/6`; // √Åreas agrupadas (pol√≠gonos) -> heat
  const CP_LAYER  = `${CCPP_BASE}/4`; // Centros poblados (puntos) -> lista/zoom
  const LIM_BASE  = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/COES/Limites_Pol%C3%ADticos/MapServer";
  const LIM0 = `${LIM_BASE}/0`, LIM1 = `${LIM_BASE}/1`, LIM2 = `${LIM_BASE}/2`;

  /* ====== MAPA (sat√©lite) ====== */
  const map = L.map('map', { preferCanvas:true }).setView([-9,-75], 5);
  const imagery = L.esri.basemapLayer('Imagery').addTo(map);
  const imageryLabels = L.esri.basemapLayer('ImageryLabels').addTo(map);

  // Panes para glow (solo borde)
  map.createPane('glow-outer').classList.add('glow-outer');
  map.createPane('glow-mid').classList.add('glow-mid');
  map.createPane('glow-inner').classList.add('glow-inner');

  /* ====== UI ====== */
  const $dep = document.getElementById('selDep');
  const $prov = document.getElementById('selProv');
  const $dist = document.getElementById('selDist');
  const $cp = document.getElementById('selCP');
  const $btnClear = document.getElementById('btnClear');
  const $btnZoom = document.getElementById('btnZoom');

  // Burbujas
  const $btnLayers = document.getElementById('btnLayers');
  const $btnLegend = document.getElementById('btnLegend');
  const $bubbleLayers = document.getElementById('bubbleLayers');
  const $bubbleLegend = document.getElementById('bubbleLegend');
  function toggle(id){ const el=document.querySelector(id); el.style.display = (el.style.display==='block'?'none':'block'); }
  $btnLayers.onclick=()=>toggle('#bubbleLayers');
  $btnLegend.onclick=()=>toggle('#bubbleLegend');
  document.querySelectorAll('[data-close]').forEach(b=>b.onclick=()=>{document.querySelector(b.dataset.close).style.display='none';});
  // Arrastrable
  function makeDraggable(header){
    const box=document.querySelector(header.dataset.drag);
    let ox=0,oy=0,drag=false;
    header.addEventListener('mousedown',e=>{drag=true;ox=e.clientX-box.offsetLeft;oy=e.clientY-box.offsetTop;e.preventDefault();});
    window.addEventListener('mousemove',e=>{if(!drag)return;box.style.left=(e.clientX-ox)+'px';box.style.top=(e.clientY-oy)+'px';box.style.right='auto';});
    window.addEventListener('mouseup',()=>drag=false);
    header.addEventListener('touchstart',e=>{const t=e.touches[0];drag=true;ox=t.clientX-box.offsetLeft;oy=t.clientY-box.offsetTop;});
    window.addEventListener('touchmove',e=>{if(!drag)return;const t=e.touches[0];box.style.left=(t.clientX-ox)+'px';box.style.top=(t.clientY-oy)+'px';box.style.right='auto';},{passive:false});
    window.addEventListener('touchend',()=>drag=false);
  }
  document.querySelectorAll('[data-drag]').forEach(makeDraggable);

  // Checks de capas
  const $chkHeat = document.getElementById('chkHeat');
  const $chkLabels = document.getElementById('chkLabels');
  const $chkGlow = document.getElementById('chkGlow');

  /* ====== HEAT DATA ====== */
  const allPoints = []; // {lat,lng,w,id_dpto?,id_prov?,id_dist?}
  let heatLayer = null, dataReady=false;
  let glowOuterLayer=null,glowMidLayer=null,glowInnerLayer=null;
  let flashLayer=null;

  const gradient = {0:'rgba(255,0,128,0)',0.25:'#ffd6eb',0.5:'#ff99cc',0.75:'#ff4da6',1:'#e60073'};

  function buildHeat(points){
    const latlngs=points.map(p=>[p.lat,p.lng,p.w]);
    if(heatLayer){heatLayer.setLatLngs(latlngs);return;}
    heatLayer=L.heatLayer(latlngs,{radius:10,blur:12,max:0.35,minOpacity:0.15,maxZoom:12,gradient}).addTo(map);
  }

  function filterPoints(){
    if(!dataReady)return;
    const dep=$dep.value.trim(),prov=$prov.value.trim(),dist=$dist.value.trim();
    let pts=allPoints;
    if(dep  && pts.some(p=>p.id_dpto!=null)) pts=pts.filter(p=>p.id_dpto===dep);
    if(prov && pts.some(p=>p.id_prov!=null)) pts=pts.filter(p=>p.id_prov===prov);
    if(dist && pts.some(p=>p.id_dist!=null)) pts=pts.filter(p=>p.id_dist===dist);
    if(!pts.length) pts = allPoints;
    buildHeat(pts);
  }

  function clearGlow(){
    [glowOuterLayer,glowMidLayer,glowInnerLayer].forEach(Lyr=>{if(Lyr)map.removeLayer(Lyr);});
    glowOuterLayer=glowMidLayer=glowInnerLayer=null;
  }
  function colorForLevel(l){return l==='dist'?'#ff69b4':(l==='prov'?'#ffd700':'#00ffff');}
  function drawGlow(geojson,level){
    clearGlow();
    const c=colorForLevel(level);
    const sOuter={color:c, weight:8, opacity:.25, fill:false};
    const sMid  ={color:c, weight:4.5, opacity:.55, fill:false};
    const sInner={color:c, weight:2, opacity:1, fill:false};
    glowOuterLayer=L.geoJSON(geojson,{pane:'glow-outer',style:sOuter}).addTo(map);
    glowMidLayer  =L.geoJSON(geojson,{pane:'glow-mid',  style:sMid}).addTo(map);
    glowInnerLayer=L.geoJSON(geojson,{pane:'glow-inner',style:sInner}).addTo(map);

    // Peque√±o flash de borde
    let i=0,seq=[1,.2,1,.2,1];const t=setInterval(()=>{if(glowInnerLayer)glowInnerLayer.setStyle({opacity:seq[i++]});if(i>=seq.length)clearInterval(t);},140);
  }

  function zoomGlowTo(dep,prov,dist){
    let url=null,where=null,level=null;
    if(dist){url=LIM2;where=`id_dist='${dist.replace(/'/g,"''")}'`;level='dist';}
    else if(prov){url=LIM1;where=`id_prov='${prov.replace(/'/g,"''")}'`;level='prov';}
    else if(dep){url=LIM0;where=`id_dpto='${dep.replace(/'/g,"''")}'`;level='dep';}
    else{map.setView([-9,-75],5);clearGlow();return;}
    L.esri.query({url}).where(where).returnGeometry(true).fields([]).limit(1).run((err,fc)=>{
      if(err||!fc||!fc.features||!fc.features.length)return;
      const gj=L.geoJSON(fc);map.fitBounds(gj.getBounds(),{padding:[34,34]});
      if($chkGlow.checked) drawGlow(fc,level);
    });
  }

  // Flash marker para CCPP
  function flashPoint(latlng){
    if(flashLayer) map.removeLayer(flashLayer);
    flashLayer=L.circleMarker(latlng,{radius:10,color:'#ffff00',weight:2,fillOpacity:0}).addTo(map);
    let i=0, seq=[1,.2,1,.2,1,.2,1];
    const int=setInterval(()=>{if(flashLayer)flashLayer.setStyle({opacity:seq[i++]});if(i>=seq.length){clearInterval(int);}},140);
  }

  function clearFilters(){
    $dep.value="";
    $prov.innerHTML=`<option value="">(Todas)</option>`;$prov.disabled=true;
    $dist.innerHTML=`<option value="">(Todos)</option>`;$dist.disabled=true;
    $cp.innerHTML=`<option value="">(Todos)</option>`;$cp.disabled=true;
    clearGlow(); if(flashLayer){map.removeLayer(flashLayer); flashLayer=null;}
    filterPoints(); map.setView([-9,-75],5);
  }

  /* ====== CARGA LISTAS ====== */
  function loadDeps(){
    L.esri.query({url:LIM0}).where('1=1').returnGeometry(false).fields(['id_dpto','nom_dep']).orderBy('nom_dep')
    .run((err,fc)=>{
      if(err){console.error("[Deps]",err);return;}
      const opts=(fc.features||[]).map(f=>`<option value="${(f.properties||f.attributes).id_dpto}">${(f.properties||f.attributes).nom_dep}</option>`).join('');
      $dep.innerHTML=`<option value="">(Todos)</option>`+opts;
    });
  }
  function loadProvs(){
    const dep=$dep.value.trim();
    $prov.innerHTML=`<option value="">(Todas)</option>`;$prov.disabled=true;
    $dist.innerHTML=`<option value="">(Todos)</option>`;$dist.disabled=true;
    $cp.innerHTML =`<option value="">(Todos)</option>`;$cp.disabled=true;
    if(!dep){clearGlow();return;}
    L.esri.query({url:LIM1}).where(`id_dep='${dep.replace(/'/g,"''")}'`).returnGeometry(false).fields(['id_prov','nom_prov']).orderBy('nom_prov')
    .run((err,fc)=>{
      if(err){console.error("[Provs]",err);return;}
      const opts=(fc.features||[]).map(f=>`<option value="${(f.properties||f.attributes).id_prov}">${(f.properties||f.attributes).nom_prov}</option>`).join('');
      $prov.innerHTML+=opts; $prov.disabled=false;
    });
  }
  function loadDists(){
    const prov=$prov.value.trim();
    $dist.innerHTML=`<option value="">(Todos)</option>`;$dist.disabled=true;
    $cp.innerHTML =`<option value="">(Todos)</option>`;$cp.disabled=true;
    if(!prov){clearGlow();return;}
    L.esri.query({url:LIM2}).where(`id_prov='${prov.replace(/'/g,"''")}'`).returnGeometry(false).fields(['id_dist','nom_dist']).orderBy('nom_dist')
    .run((err,fc)=>{
      if(err){console.error("[Dists]",err);return;}
      const opts=(fc.features||[]).map(f=>`<option value="${(f.properties||f.attributes).id_dist}">${(f.properties||f.attributes).nom_dist}</option>`).join('');
      $dist.innerHTML+=opts; $dist.disabled=false;
    });
  }
  function loadCPs(){
    const dist=$dist.value.trim();
    $cp.innerHTML=`<option value="">(Todos)</option>`;$cp.disabled=true;
    if(!dist) return;
    L.esri.query({url:CP_LAYER})
      .where(`ubigeo='${dist.replace(/'/g,"''")}'`)
      .returnGeometry(false).fields(['nom_ccpp','ubigeo']).orderBy('nom_ccpp')
      .run((err,fc)=>{
        if(err){console.error("[CPs]",err);return;}
        const seen=new Set(); const opts=[];
        (fc.features||[]).forEach(f=>{
          const a=f.properties||f.attributes||{};
          const name=a.nom_ccpp, ubg=a.ubigeo;
          if(name && ubg && !seen.has(name)){ seen.add(name); opts.push(`<option value="${ubg}::${name.replace(/"/g,'&quot;')}">${name}</option>`); }
        });
        $cp.innerHTML+=opts.join(''); $cp.disabled=(opts.length===0);
      });
  }

  /* ====== EVENTOS ====== */
  $dep.addEventListener('change', ()=>{
    loadProvs();
    filterPoints();
    zoomGlowTo($dep.value.trim(), $prov.value.trim(), $dist.value.trim());
  });
  $prov.addEventListener('change', ()=>{
    loadDists();
    filterPoints();
    zoomGlowTo($dep.value.trim(), $prov.value.trim(), $dist.value.trim());
  });
  $dist.addEventListener('change', ()=>{
    loadCPs();
    filterPoints();
    zoomGlowTo($dep.value.trim(), $prov.value.trim(), $dist.value.trim());
  });

  // Al elegir CCPP: sincroniza y centra
  $cp.addEventListener('change', async ()=>{
    const v=$cp.value.trim();
    if(!v){ filterPoints(); zoomGlowTo($dep.value.trim(), $prov.value.trim(), $dist.value.trim()); return; }
    const [ubg, nameRaw] = v.split('::');
    if(!ubg || ubg.length<6) return;
    const dep=ubg.slice(0,2), prov=ubg.slice(0,4), dist=ubg.slice(0,6);

    // Sincroniza combos en cascada (peque√±os delays para rellenar)
    if($dep.value!==dep){ $dep.value=dep; await new Promise(r=>{ loadProvs(); setTimeout(r, 250); }); }
    if($prov.value!==prov){ $prov.value=prov; await new Promise(r=>{ loadDists(); setTimeout(r, 250); }); }
    if($dist.value!==dist){ $dist.value=dist; await new Promise(r=>{ loadCPs(); setTimeout(r, 250); }); }

    filterPoints();
    zoomGlowTo(dep,prov,dist);

    // Centra al punto del CCPP
    L.esri.query({url:CP_LAYER})
      .where(`ubigeo='${dist.replace(/'/g,"''")}' AND nom_ccpp='${(nameRaw||'').replace(/'/g,"''")}'`)
      .returnGeometry(true).fields([]).limit(1)
      .run((err,fc)=>{
        if(err||!fc.features||!fc.features.length) return;
        const g = fc.features[0].geometry;
        if(g && g.type==='Point'){
          const [lng,lat]=g.coordinates;
          map.setView([lat,lng], 14);
          flashPoint([lat,lng]);
        }
      });
  });

  $btnClear.addEventListener('click', ()=> clearFilters());
  $btnZoom .addEventListener('click', ()=> zoomGlowTo($dep.value.trim(), $prov.value.trim(), $dist.value.trim()));

  // Toggling de capas desde el panel
  $chkHeat.addEventListener('change', ()=>{ if(!heatLayer) return; if($chkHeat.checked){heatLayer.addTo(map);} else {map.removeLayer(heatLayer);} });
  $chkLabels.addEventListener('change', ()=>{ if($chkLabels.checked){imageryLabels.addTo(map);} else {map.removeLayer(imageryLabels);} });
  $chkGlow.addEventListener('change', ()=>{ if(!$chkGlow.checked) clearGlow(); else zoomGlowTo($dep.value.trim(), $prov.value.trim(), $dist.value.trim()); });

  /* ====== CARGA HEAT (paginado) ====== */
  const pageSize=2000; let resultOffset=0;
  function fetchPage(o){
    return new Promise((res,rej)=>{
      L.esri.query({url:SERVICE})
        .where('1=1').returnGeometry(true).fields(['*'])
        .limit(pageSize).offset(o)
        .run((e,fc,raw)=>e?rej(e):res({fc,raw}));
    });
  }

  (async()=>{
    while(true){
      const {fc,raw}=await fetchPage(resultOffset);
      const feats=fc && fc.features ? fc.features : [];
      if(!feats.length)break;

      feats.forEach(f=>{
        if(!f.geometry) return;
        if(f.geometry.type==='Polygon' || f.geometry.type==='MultiPolygon'){
          const c=turf.pointOnSurface(f); if(!c||!c.geometry) return;
          const [lng,lat]=c.geometry.coordinates;
          const a=f.properties||f.attributes||{};
          allPoints.push({
            lat,lng,w:1,
            id_dpto:a.id_dpto ?? null,
            id_prov:a.id_prov ?? null,
            id_dist:a.id_dist ?? null
          });
        }
      });

      resultOffset+=pageSize;
      if(feats.length<pageSize && raw && raw.exceededTransferLimit!==true) break;
    }

    buildHeat(allPoints); dataReady=true; loadDeps();
  })();
})();
</script>
</body>
</html>
