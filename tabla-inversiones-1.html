<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Listado MEF · Tabla</title>
<style>
  :root{
    --ink:#0b2532; --muted:#6b7b86; --line:#e6ecea; --bg:#f4faf8;
    --chip:#0b3b38; --chip-ink:#d7fff6;
    --link:#0a5a51; --link-h:#094c45; --row-alt:#f9fcfb;
    --tip-bg: rgba(15,46,41,.92);
    --tip-ink:#eafff9;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font:12px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:1180px;margin:10px auto 18px;padding:0 10px}

  .topbar{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #0e4a43;
    background:var(--chip);color:var(--chip-ink);padding:7px 10px;border-radius:999px;
    font-weight:800;cursor:pointer;box-shadow:0 6px 14px rgba(2,6,23,.15)}
  .btn.small{padding:6px 8px;border-radius:10px}
  .btn .ic{width:14px;height:14px;display:inline-block}
  .btn:hover{filter:brightness(1.05)}
  .spacer{flex:1}

  .panel{display:none;background:var(--chip);color:#e6fffb;border:1px solid #0e4a43;
    border-radius:14px;padding:12px;margin:6px 0 12px}
  .panel.open{display:block}
  /* 4 campos (Dep/Prov/Dist/Programa) + botón limpiar */
  .row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:10px;align-items:end}
  label{display:block;font-size:11px;font-weight:800;color:#d0fff4;margin:2px 0 6px}
  select{width:100%;border-radius:10px;padding:8px 10px;border:1px solid #155149;
    background:#0f2e29;color:#e6fffb;outline:none;font-weight:600;height:36px}
  .popbtn{background:#0f2e29;border:1px solid #155149;color:#d8fff8}
  .tip{font-size:11px;color:#bfeee4;margin-top:8px}

  /* === Multiselect Programa (uniforme con los select) === */
  .custom-select{position:relative;width:100%}
  .select-display{
    width:100%;border-radius:10px;padding:8px 10px;border:1px solid #155149;
    background:#0f2e29;color:#e6fffb;cursor:pointer;display:flex;justify-content:space-between;align-items:center;
    font-size:12.5px;box-sizing:border-box;height:36px;font-weight:600
  }
  .select-display::after{content:'▾';font-weight:900}
  .dropdown-content{
    display:none;position:absolute;top:100%;left:0;width:100%;max-height:240px;overflow-y:auto;
    border:1px solid #155149;border-radius:10px;background:#0f2e29;z-index:10;padding:8px;box-sizing:border-box;
    box-shadow:0 10px 24px rgba(2,6,23,.12)
  }
  .dropdown-content.show{display:block}
  .dropdown-content label{
    display:flex;align-items:center;gap:8px;color:#e6fffb;padding:6px 6px;font-size:12px;font-weight:600;user-select:none
  }
  .dropdown-content input[type="checkbox"]{accent-color:#e6fffb;width:16px;height:16px;margin:0}

  .tableWrap{background:#fff;border:1px solid var(--line);border-radius:10px;
    box-shadow:0 10px 26px rgba(2,6,23,.08);overflow:hidden}
  .scrollX{overflow-x:auto}
  table{width:100%;border-collapse:collapse;table-layout:fixed}
  thead th{
    position:sticky;top:0;z-index:2;
    background:#0e2f2b;color:#e9fff9;border-bottom:1px solid var(--line);
    font-size:11.5px;letter-spacing:.2px;padding:8px 6px;text-align:center
  }
  tbody td{
    border-top:1px solid var(--line);border-right:1px solid var(--line);
    padding:7px 6px;vertical-align:top;font-size:11.5px
  }
  tbody tr:nth-child(odd){background:var(--row-alt)}
  tbody td:last-child, thead th:last-child{border-right:none}
  .num{font-variant-numeric:tabular-nums;text-align:right}

  col.cui{width:70px}
  col.inv{width:300px}
  col.dep{width:120px}
  col.pro{width:120px}
  col.dis{width:140px}
  col.pim{width:110px}
  col.dev{width:110px}
  col.det{width:100px}
  col.pdf{width:100px}

  /* Ellipsis + tooltip para “Inversión” */
  .inv-cell{position:relative;overflow:visible}
  .ellip-text{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .inv-cell[data-tip]::after{
    content:attr(data-tip);position:absolute;left:0;bottom:100%;transform:translateY(-6px);
    background:var(--tip-bg);color:var(--tip-ink);padding:6px 8px;border-radius:6px;max-width:560px;width:max-content;min-width:180px;
    white-space:normal;line-height:1.25;font-size:11px;pointer-events:none;z-index:50;border:1px solid rgba(8,31,28,.35);box-shadow:0 6px 14px rgba(0,0,0,.18);
    opacity:0;visibility:hidden;transition:opacity .12s ease,visibility .12s ease
  }
  .inv-cell[data-tip]::before{
    content:"";position:absolute;left:10px;bottom:100%;transform:translateY(-2px);border:6px solid transparent;border-top-color:var(--tip-bg);
    z-index:51;opacity:0;visibility:hidden;transition:opacity .12s ease,visibility .12s ease
  }
  .inv-cell:hover::after,.inv-cell:hover::before,.inv-cell:focus-within::after,.inv-cell:focus-within::before{opacity:1;visibility:visible}

  .chipLink{color:var(--link);font-weight:800;text-decoration:none}
  .chipLink:hover{color:var(--link-h);text-decoration:underline}
  .pill{background:#eef7f6;color:#115750;padding:3px 8px;border-radius:999px;font-weight:800}

  .status{padding:10px 0;color:#334155;font-weight:700}
  .error{color:#9b1c1c}
  .note{font-size:10px;font-style:italic;margin-left:6px;color:#64748b}

  @media (max-width:860px){
    .row{grid-template-columns:1fr;gap:8px}
  }
</style>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <button id="btnFilters" class="btn small" title="Filtros">
      <svg class="ic" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M6 12h12M9 18h6" stroke="#bff3e9" stroke-width="2" stroke-linecap="round"/></svg>
      Filtros
    </button>
    <div class="spacer"></div>
    <button id="btnExcel" class="btn small" title="Exportar a Excel (CSV)">
      <svg class="ic" viewBox="0 0 24 24" fill="none">
        <path d="M14 3h4a2 2 0 0 1 2 2v4" stroke="#bff3e9" stroke-width="2"/>
        <path d="M14 3v6h6" stroke="#bff3e9" stroke-width="2"/>
        <rect x="3" y="7" width="14" height="14" rx="2" stroke="#bff3e9" stroke-width="2"/>
        <path d="M7.5 12.5 11 16m0-3.5L7.5 16" stroke="#bff3e9" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
  </div>

  <!-- PANEL DE FILTROS (recogido por defecto) -->
  <div id="panel" class="panel" aria-hidden="true">
    <div class="row">
      <div>
        <label for="selDep">Departamento</label>
        <select id="selDep"><option value="">(Todos)</option></select>
      </div>
      <div>
        <label for="selProv">Provincia</label>
        <select id="selProv" disabled><option value="">(Todos)</option></select>
      </div>
      <div>
        <label for="selDist">Distrito</label>
        <select id="selDist" disabled><option value="">(Todos)</option></select>
      </div>

      <!-- PROGRAMA (al final, estilo uniforme) -->
      <div>
        <label for="progSelect">Programa</label>
        <div class="custom-select" id="progSelect">
          <div class="select-display" id="progDisplay">(Todos)</div>
          <div class="dropdown-content" id="progDropdown"></div>
        </div>
      </div>

      <button id="btnClear" class="btn small popbtn" type="button">Limpiar</button>
    </div>
    <div class="tip">Los filtros se aplican automáticamente y también afectan a la exportación.</div>
  </div>

  <div id="state" class="status">Cargando datos…</div>

  <div class="tableWrap">
    <div class="scrollX">
      <table id="tbl">
        <colgroup>
          <col class="cui"><col class="inv"><col class="dep"><col class="pro"><col class="dis">
          <col class="pim"><col class="dev"><col class="det"><col class="pdf">
        </colgroup>
        <thead>
          <tr>
            <th>CUI</th>
            <th>Inversión</th>
            <th>Departamento</th>
            <th>Provincia</th>
            <th>Distrito</th>
            <th>PIM</th>
            <th>Devengado</th>
            <th>Detalle Proyecto</th>
            <th>Ayuda Memoria</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const FS_URL = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_Coord_MEF/FeatureServer/0";
let ROWS = [];
const fields = [
  "producto_proyecto","producto_proyecto_nombre",
  "departamento","provincia","distrito","programa",
  "monto_pim","monto_devengado","url_ssp","url_pdf"
].join(",");

function fmtMoney(n){ return n ? ("S/ " + new Intl.NumberFormat('es-PE',{maximumFractionDigits:2}).format(n)) : "—"; }
function escQuotes(v){ return String(v).replaceAll("'","''"); }
function escLike(v){ return escQuotes(String(v).replaceAll("%","\\%").replaceAll("_","\\_")); }
function cacheBust(){ return String(Date.now()); }
function esriPOST(url, obj){
  const body = new URLSearchParams({f:"json",returnGeometry:"false",...obj,__ts:cacheBust()});
  return fetch(url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body})
    .then(r=>{ if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); })
    .then(j=>{ if(j.error){ throw new Error(j.error.message||"ArcGIS"); } return j; });
}
function escapeHtml(s){ return String(s).replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

/* ====== MULTISELECT PROGRAMA (mismo look&feel) ====== */
const progDisplay  = document.getElementById('progDisplay');
const progDropdown = document.getElementById('progDropdown');

function getSelectedPrograms(){
  return Array.from(progDropdown.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.value);
}
function updateProgDisplay(triggerApply=true){
  const checked = getSelectedPrograms();
  if(checked.length===0)      progDisplay.textContent='(Todos)';
  else if(checked.length===1) progDisplay.textContent=checked[0];
  else                        progDisplay.textContent=`${checked.length} seleccionados`;
  if(triggerApply) applyFilters();
}
progDisplay.addEventListener('click',()=>progDropdown.classList.toggle('show'));
document.addEventListener('click',(ev)=>{
  if(!document.getElementById('progSelect').contains(ev.target)){
    progDropdown.classList.remove('show');
  }
});
async function refreshProg(){
  // Limitar lista según dep/prov/dist para coherencia
  const dep = document.getElementById('selDep').value.trim();
  const pro = document.getElementById('selProv').value.trim();
  const dis = document.getElementById('selDist').value.trim();
  const parts=["1=1"];
  if(dep) parts.push(`departamento='${escQuotes(dep)}'`);
  if(pro) parts.push(`provincia LIKE '%${escLike(pro)}%' ESCAPE '\\'`);
  if(dis) parts.push(`distrito  LIKE '%${escLike(dis)}%' ESCAPE '\\'`);
  const whereProg = parts.join(" AND ");

  // preservar selección
  const prev = new Set(getSelectedPrograms());

  progDropdown.innerHTML = '';
  try{
    const arr = await loadDistinct("programa", whereProg);
    arr.forEach(v=>{
      const val = String(v);
      const checked = prev.has(val) ? 'checked' : '';
      progDropdown.insertAdjacentHTML("beforeend",
        `<label><input type="checkbox" value="${val.replaceAll('"','&quot;')}" ${checked}> ${escapeHtml(val)}</label>`);
    });
  }catch(e){ console.warn("Distinct programa falló:", e); }

  // re-bind
  progDropdown.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change', ()=>updateProgDisplay(true));
  });
  updateProgDisplay(false);
}

/* ====== WHERE ====== */
function buildWhere(){
  const dep=document.getElementById('selDep').value.trim();
  const pro=document.getElementById('selProv').value.trim();
  const dis=document.getElementById('selDist').value.trim();
  const progs=getSelectedPrograms();

  const parts=["1=1"];
  if(dep) parts.push(`departamento='${escQuotes(dep)}'`);
  if(pro) parts.push(`provincia LIKE '%${escLike(pro)}%' ESCAPE '\\'`);
  if(dis) parts.push(`distrito  LIKE '%${escLike(dis)}%' ESCAPE '\\'`);
  if(progs.length>0){
    const list = progs.map(p=>`'${escQuotes(p)}'`).join(",");
    parts.push(`programa IN (${list})`);
  }
  return parts.join(" AND ");
}

async function loadDistinct(field, where){
  const page=2000; let offset=0; const vals=new Set();
  while(true){
    const j = await esriPOST(FS_URL+"/query",{
      where:where||"1=1", outFields:field, returnDistinctValues:"true",
      orderByFields:field, resultRecordCount:page, resultOffset:offset
    });
    const rows=(j.features||[]).map(f=>(f.attributes||{})[field]).filter(v=>v!=null&&v!=="");
    rows.forEach(v=>vals.add(v));
    if(!j.exceededTransferLimit || rows.length<page) break;
    offset+=page;
  }
  return [...vals];
}

async function loadRows(where){
  const state = document.getElementById('state');
  state.textContent="Cargando datos…";
  const page=2000; let offset=0; const out=[];
  try{
    while(true){
      const j = await esriPOST(FS_URL+"/query", {
        where: where || "1=1",
        outFields: fields,
        orderByFields: "monto_pim DESC",
        resultRecordCount: page, resultOffset: offset
      });
      (j.features||[]).forEach(f=>{
        const a=f.attributes||{};
        out.push({
          cui:a.producto_proyecto??"",
          inv:a.producto_proyecto_nombre??"",
          dep:a.departamento??"",
          pro:a.provincia??"",
          dis:a.distrito??"",
          pim:Number(a.monto_pim)||0,
          dev:Number(a.monto_devengado)||0,
          ssp:a.url_ssp??"",
          pdf:a.url_pdf??""
        });
      });
      if(!j.exceededTransferLimit || (j.features||[]).length<page) break;
      offset+=page;
    }
    ROWS=out; render(out);
    state.innerHTML=`Listo (${out.length.toLocaleString('es-PE')} filas) <span class="note">Incluye inversiones cuyo PIM sea mayor a 0</span>`;
  }catch(e){
    console.error(e);
    state.classList.add('error');
    state.textContent="No se pudo cargar la tabla (ver consola).";
  }
}

function render(rows){
  const tb=document.getElementById("tbody");
  tb.innerHTML = rows.map(r=>`
    <tr>
      <td class="num">${r.cui||"—"}</td>
      <td class="inv-cell" data-tip="${escapeHtml(r.inv||"—")}">
        <span class="ellip-text" tabindex="0">${escapeHtml(r.inv||"—")}</span>
      </td>
      <td>${escapeHtml(r.dep)||"—"}</td>
      <td>${escapeHtml(r.pro)||"—"}</td>
      <td>${escapeHtml(r.dis)||"—"}</td>
      <td class="num">${fmtMoney(r.pim)}</td>
      <td class="num">${fmtMoney(r.dev)}</td>
      <td>${r.ssp?`<a class="chipLink" href="${r.ssp}" target="_blank" rel="noopener">Ver Detalle</a>`:`<span class="pill">—</span>`}</td>
      <td>${r.pdf?`<a class="chipLink" href="${r.pdf}" target="_blank" rel="noopener">Ver PDF</a>`:`<span class="pill">—</span>`}</td>
    </tr>`).join("");
}

/* Export CSV */
function toCSV(rows){
  const sep = ";";
  const header=["CUI","Inversion","Departamento","Provincia","Distrito","PIM","Devengado","Detalle_Proyecto","Ayuda_Memoria"];
  const esc=v=>`"${String(v??"").replace(/"/g,'""')}"`;
  const lines = rows.map(r=>[
    r.cui, r.inv, r.dep, r.pro, r.dis,
    (r.pim ?? 0), (r.dev ?? 0), r.ssp, r.pdf
  ].map(esc).join(sep));
  return header.join(sep)+"\n"+lines.join("\n");
}
function downloadCSV(){
  const csv=toCSV(ROWS);
  const bom = new Uint8Array([0xEF,0xBB,0xBF]);
  const blob=new Blob([bom, csv],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download="inversiones_mef.csv";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href),1500);
}

/* UI */
const panel=document.getElementById('panel');
document.getElementById('btnFilters').addEventListener('click',()=>{
  panel.classList.toggle('open');
  panel.setAttribute('aria-hidden', panel.classList.contains('open') ? "false":"true");
});
document.getElementById('btnExcel').addEventListener('click',downloadCSV);

const selDep=document.getElementById('selDep');
const selProv=document.getElementById('selProv');
const selDist=document.getElementById('selDist');

async function refreshDep(){
  selDep.innerHTML = `<option value="">(Todos)</option>`;
  try{
    const deps=await loadDistinct("departamento");
    deps.forEach(v => selDep.insertAdjacentHTML("beforeend", `<option>${escapeHtml(v)}</option>`));
  }catch(e){ console.warn("Distinct dep falló:", e); }
  selProv.innerHTML = `<option value="">(Todos)</option>`; selProv.disabled = true;
  selDist.innerHTML = `<option value="">(Todos)</option>`; selDist.disabled = true;
  await refreshProg(); // actualizar lista de programas según selección
}
async function refreshProv(){
  const dep = selDep.value.trim();
  selProv.innerHTML = `<option value="">(Todos)</option>`;
  selDist.innerHTML = `<option value="">(Todos)</option>`; selDist.disabled = true;
  if(!dep){ selProv.disabled=true; applyFilters(); await refreshProg(); return; }
  try{
    const provs=await loadDistinct("provincia", `departamento='${escQuotes(dep)}'`);
    provs.forEach(v => selProv.insertAdjacentHTML("beforeend", `<option>${escapeHtml(v)}</option>`));
    selProv.disabled = false;
  }catch(e){ console.warn("Distinct prov falló:", e); selProv.disabled=true; }
  applyFilters();
  await refreshProg();
}
async function refreshDist(){
  const dep = selDep.value.trim();
  const pro = selProv.value.trim();
  selDist.innerHTML = `<option value="">(Todos)</option>`;
  if(!dep || !pro){ selDist.disabled = true; applyFilters(); await refreshProg(); return; }
  try{
    const dists=await loadDistinct("distrito",
      `departamento='${escQuotes(dep)}' AND provincia LIKE '%${escLike(pro)}%' ESCAPE '\\'`);
    dists.forEach(v => selDist.insertAdjacentHTML("beforeend", `<option>${escapeHtml(v)}</option>`));
    selDist.disabled = false;
  }catch(e){ console.warn("Distinct dist falló:", e); selDist.disabled=true; }
  applyFilters();
  await refreshProg();
}

/* aplicar filtros a la tabla */
function applyFilters(){
  const where = buildWhere();
  loadRows(where);
}

/* eventos */
selDep.addEventListener('change', refreshProv);
selProv.addEventListener('change', refreshDist);
selDist.addEventListener('change', applyFilters);

document.getElementById('btnClear').addEventListener('click', async ()=>{
  // limpiar selects
  selDep.value = ""; selProv.value=""; selDist.value="";
  selProv.disabled=true; selDist.disabled=true;
  // limpiar programas
  progDropdown.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);
  updateProgDisplay(false);
  await refreshProg();
  await loadRows("1=1");
});

/* ====== helpers comunes ====== */
async function loadDistinct(field, where){
  const page=2000; let offset=0; const vals=new Set();
  while(true){
    const j = await esriPOST(FS_URL+"/query",{
      where:where||"1=1", outFields:field, returnDistinctValues:"true",
      orderByFields:field, resultRecordCount:page, resultOffset:offset
    });
    const rows=(j.features||[]).map(f=>(f.attributes||{})[field]).filter(v=>v!=null&&v!=="");
    rows.forEach(v=>vals.add(v));
    if(!j.exceededTransferLimit || rows.length<page) break;
    offset+=page;
  }
  return [...vals];
}

/* init */
(async function init(){
  await loadRows("1=1");
  await refreshDep().catch(()=>{});
  await refreshProg().catch(()=>{});
  // seguridad: re-bind
  progDropdown.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change', ()=>updateProgDisplay(true));
  });
})();
</script>
</body>
</html>
